<!-- Log Sysmon Alerts -->
<group name="sysmon">
	<rule id="101100" level="5">
		<if_sid>61600</if_sid>
		<field name="win.system.eventID">^22$</field>
		<description>Sysmon - Event 22: DNS Query.</description>
		<options>no_full_log</options>
	</rule>
	<rule id="101101" level="3">
		<if_sid>61603</if_sid>                                              
      <options>no_full_log</options>
		<description>Sysmon - Event 1: Creación de proceso.</description>
	</rule>

	<rule id="101102" level="14">
		<if_sid>61604</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 2: A process changed a file creation time.</description>
	</rule>
	<rule id="101103" level="5">
		<if_sid>61605</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 3: Network connection.</description>
	</rule>
	
	<rule id="101104" level="5">
		<if_sid>61606</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 4: Sysmon service state changed</description>
	</rule>
    <rule id="101154" level="5">
        <if_sid>101104</if_sid>
        <field name="win.eventdata.state">Started</field>
        <description>Servicio de Sysmon ha iniciado</description>
    </rule>
	<rule id="101106" level="5">
		<if_sid>61608</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 6: Driver loaded.</description>
	</rule>

	<rule id="101108" level="5">
		<if_sid>61610</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 8: CreateRemoteThread.</description>
	</rule>
	
	<!--Este evento registra los archivos que se escriben en el disco del sistema, por ejemplo si se crea un directorio, descargas, cambios temporales relacionados a servicios o ejecutables, tambien cuando se copia o se mueve un directorio o archivo entre otros eventos-->
	<rule id="101111" level="5">
		<if_sid>61613</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 11: FileCreate: $(win.eventdata.targetFileName)</description>
	</rule>
	
	<rule id="101112" level="5">
		<if_sid>61614</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 12: RegistryEvent (Object create and delete).</description>
	</rule>
	
	<rule id="101113" level="5">
		<if_sid>61615</if_sid>
      <options>no_full_log</options>
		<description>Sysmon - Event 13: RegistryEvent. Objeto: $(win.eventdata.targetObject)</description>
	</rule>
	
	<!--genera muchos eventos, especificar qué se quiere detectar-->
	<!--<rule id="101114" level="3">-->
	<!--    <if_sid>61650</if_sid>-->
 <!--       <options>no_full_log</options>-->
	<!--    <description>Sysmon - Event 22: DNS Query</description>-->
	<!--</rule>-->
	
  <rule id="92031" level="3" overwrite="yes">
    <if_group>sysmon_event1</if_group>
    <field name="win.eventdata.originalFileName" type="pcre2">(?i)(net\.EXE|net1\.EXE)</field>
    <options>no_full_log</options>
    <description>Discovery activity executed</description>
    <mitre>
      <id>T1087</id>
    </mitre>
  </rule>
	<!--excluir net.exe accounts de ossec-->
	<rule id="101254" level="0">
	   <if_sid>92031</if_sid>
	   <field name="win.eventdata.currentDirectory">ossec-agent</field>
	   <field name="win.eventdata.image">net.exe$</field>
	   <description>net.exe ejecutado por ossec</description>
	</rule>
	
	<!--***************************************** Mis Excepciones de Sysmon apartir de aquí ************************************************-->
	<!--if_sid 101101: Event 1, creación de proceso-->
	<!--Proceso conent.exe es la ventana de permisos especiales de windows-->
	<rule id="101115" level="10">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.image">System32\\\\consent.exe$</field>
        <description>Se ha habilitado la ventana de permisos especiales de Windows</description>
    </rule>
	
	<rule id="101116" level="14">
	    <if_sid>101101</if_sid>
	    <field name="win.eventdata.image">\\\\Windows\\\\SysWOW64\\\\auditpol.exe</field>
	    <field name="win.enventdata.parentUser">NT AUTHORITY\\\\SYSTEM$</field>
	    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM$</field>
	    <description>Politica de auditoria del sistema</description>
	</rule>
	
	<!--***************************************** Reglas principales ************************************************-->
  <!-- Renzo: Regla principal de PowerShell. Se modifica la regla para que muestre en la descripcion el nivel de integridad, Medium significa abrir PowerShell normalmente, High significa Privilegios de Administrador y System significa Privilegios máximos de System -->

    <rule id="101119" level="14" overwrite="yes">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
        <description>PowerShell iniciado con nivel de privilegios $(win.eventdata.integritylevel)</description>
    </rule>
  
  <!-- Renzo: Regla principal de CMD. Se modifica la regla para que muestre en la descripcion el nivel de integridad, Medium significa abrir CMD normalmente, High significa Privilegios de Administrador y System significa Privilegios máximos de System -->
   <rule id="101126" level="14">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\cmd.exe$</field>
        <description>CMD iniciado con nivel de privilegios $(win.eventdata.integritylevel)</description>
   </rule>
  
	<!--***************************************** Reglas principales ************************************************-->


  

  <!--Segmentando exclusivamente el proceso MiFactura,
	esta regla detecta el proceso en si, luego en otra regla se debe apuntar a ésta regla y especificar si el parentUser y el User son xUser entonces mostrar la siguiente alerta, caso contrario mostrar ésta-->
	<rule id="101117" level="14">
	    <if_sid>101101</if_sid>
	    <field name="win.eventdata.currentDirectory" type="pcre2">(?i)[c-z]:\\\\Procesos\\\\MiFactura\\\\TM_PROD|PROD\\\\ProcesarFacturasRest|ActualizarEstadoSet</field>
	    <field name="win.eventdata.user">\.+</field>
	    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\cmd.exe</field>
	    <description>MiFactura está siendo ejecutada por un usuario que no es el habitual. Verificar usuario $(win.eventdata.user)</description>
	 </rule>
	<!--solo si el usuario es Fsanabria, lanzar alerta id 101119, éste evento ya no se guarda-->
	<rule id="101118" level="0">
	    <if_sid>101117</if_sid>
	    <field name="win.eventdata.parentUser">^GRUPOTOYOTOSHI\\\\Fsanabria$|^NT AUTHORITY\\\\SYSTEM$</field>
	    <field name="win.eventdata.user">^GRUPOTOYOTOSHI\\\\Fsanabria$</field>
	    <description>Proceso MiFactura por usuario habitual.</description>
	</rule>
	
	<!--Creacion de proceso PowerShell, primero que nada si se van a tener varios escenarios con relacion al proceso, lo primero y principal es capturar dicho proceso, y todas las variantes o escenarios que se quieren analizar después. 
	En este caso se van a analizar en qué contexto se ejecuta, si en el Directorio Users o System32. Esta regla informa qué usuario inicia Powershell-->
	<!--Tener en cuenta este proceso-->
	"Process Create:
RuleName: technique_id=T1086,technique_name=PowerShell
UtcTime: 2024-01-15 09:34:09.584
ProcessGuid: {0497a79b-fc11-65a4-ce01-00000000b500}
ProcessId: 6120
Image: C:\Python312\python.exe
FileVersion: 3.12.0
Description: Python
Product: Python
Company: Python Software Foundation
OriginalFileName: python.exe
CommandLine: "C:\Python312\python.exe" app.py
CurrentDirectory: C:\tablero\
User: GRUPOTOYOTOSHI\szarate
LogonGuid: {0497a79b-fc0d-65a4-2968-4c0000000000}
LogonId: 0x4C6829
TerminalSessionId: 1
IntegrityLevel: Medium
Hashes: SHA1=019D10326D117F1414B6CC9034ACDCE010AD2186,MD5=725FA61FAAE60AEE18B8E6E49A2F8724,SHA256=42AC541168E97DEDB9AABD8BE335539FC41C682E414B9E8D137B164FB68683B0,IMPHASH=40445B394CDBF537CB1AA287F96583BD
ParentProcessGuid: {0497a79b-fc0e-65a4-ba01-00000000b500}
ParentProcessId: 2660
ParentImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ParentCommandLine: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe python app.py
ParentUser: GRUPOTOYOTOSHI\szarate"

si el currentDirectory no es System32
	
    <!-- Renzo: Regla dada de baja por incoherencias, se crea una nueva de 0 con el mismo ID y overwrite para estar seguros, ya que en el dashboard aparecieron eventos con rule.level que no coinciden con esta regla. -->
    
    <!-- <rule id="101119" level="14">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
        <field name="win.eventdata.currentDirectory" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+|(?i)[c-z]:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.image">\.+</field>
        <field name="win.eventdata.originalFileName">\.+</field>
        <description>Creación de proceso en PowerShell. Verificar $(win.eventdata.image) </description>
    </rule> -->
    
    <!-- verificar si esta regla funciona bien al detectar un ejecutable iniciado mediante powershell -->
    <!--<rule id="101255" level="14">-->
    <!--    <if_sid>101101</if_sid>-->
    <!--    <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>-->
    <!--    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>-->
    <!--    <field name="win.eventdata.currentDirectory" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+|(?i)[c-z]:\\\\Windows\\\\system32</field>-->
    <!--    <field name="win.eventdata.originalFileName">\.exe|\.py|</field>-->
    <!--    <field name="win.eventdata.image">\.+</field>-->
    <!--    <description>Creación de proceso en PowerShell. Verificar $(win.eventdata.originalFileName) </description>-->
    <!--</rule>-->
    
    <!--alertar especificamente la ejecucion de sc.exe en powershell-->

    <!-- Renzo: La regla alertaba la modificacion de un servicio mediante Powershell. Se generaliza más y se agrega CMD a las condiciones -->
    <rule id="101120" level="15">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe|C:\\\\Windows\\\\System32\\\cmd.exe</field>
        <field name="win.eventdata.user">\.+</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\sc.exe</field>
        <description>ATENCION. Servicio modificado a través de consola.</description>
    </rule>
    <!--Si se modificó la ruta de un servicio desde powershell-->
    <rule id="104041" level="14">
        <if_sid>101120</if_sid>
        <field name="win.eventdata.commandLine">binPath</field>
        <description>Process Create: Se modificó la ruta de un servicio a través de Powershell</description>
    </rule>
    
  <!-- Renzo: Regla dada de baja porque la regla principal que creé, es capaz de indicar la ejecución de Powershell y el operador puede ver que linea de comandos fué ejecutada -->  
    
    <!--Si el directorio donde se ejecuta PowerShell es System32 significa que se ejecuta con permisos de administrador-->
   <!-- <rule id="101121" level="14">
        <if_sid>101119</if_sid>
        <field name="win.eventdata.currentDirectory" type="pcre2">C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.user">\.+</field>
        <description>Inicio de PowerShell con permisos de administrador</description>
   </rule>
   <rule id="101122" level="14">
        <if_sid>101121</if_sid>
        <field name="win.eventdata.user">^NT AUTHORITY\\\\SYSTEM$</field>
        <description>Powershell ejecutado por el sistema</description>
   </rule>
   <rule id="101123" level="14">
        <if_sid>101121</if_sid>
        <field name="win.eventdata.user" type="pcre2" negate="yes">NT AUTHORITY\\\\SYSTEM</field>
        <description>ATENCIÓN!. $(win.eventdata.user) inició PowerShell con altos privilegios</description>
   </rule> -->
   
   <!--Ejecución de PowerShell dentro del entorno de un Usuario común-->
   <!-- <rule id="101124" level="14">
        <if_sid>101119</if_sid>
        <field name="win.eventdata.currentDirectory" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+</field>
        <field name="win.eventdata.user">\.+</field>
        <description>PowerShell iniciado en el directorio de usuario $(win.eventdata.user)</description>
   </rule> -->
   
   <!-- Renzo: Regla dada de baja porque la regla principal que creé, es capaz de indicar la ejecución de Powershell y el operador puede ver que linea de comandos fué ejecutada -->
   
   <!-- <rule id="101125" level="14">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.currentDirectory" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+|(?i)[c-z]:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\.+</field>
        <field name="win.eventdata.commandLine">\.+</field>
        <description>$(win.eventdata.commandLine) ejecutado en PowerShell</description>
   </rule> -->

   
    <!--Al desactivar la regla 101127 la alerta que se genera es esta cuando se abre cmd, hay que ver que tan preciso es-->
    
   <!-- Renzo: Regla dada de baja por desuso -->

   <!-- <rule id="101127" level="14"> -->
        <!-- <if_sid>101126</if_sid>
        <field name="win.eventdata.currentDirectory">^C:\\\\Users</field>
        <description>CMD iniciado por usuario</description>
   </rule> -->

   <!-- Renzo: Regla dada de baja por desuso -->
   
   <!-- <rule id="101128" level="14">
        <if_sid>101126</if_sid>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>CMD iniciado por el sistema</description>
   </rule> -->


   <!--Verificar esta regla, no detecta que el usuario haya iniciado cmd explicitamente, tambien toma los comandos que el sistema ejecuta en el directorio del usuario-->
   <!--
   <rule id="101128" level="2">
        <if_sid>101126</if_sid>
        <field name="win.eventdata.user" type="pcre2" negate="yes">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.commandLine" type="pcre2">^%{"C:\\\\Windows\\\\system32\\\\cmd.exe\\\\"}$</field>
        <description>CMD iniciado por usuario $(win.eventdata.user)</description>
   </rule>
   -->
   <!--****************************************************************************************************************************************-->
   <!--Esta regla aparentemente toma las conexiones entre workstation y servidores tambien. Hay que ajustar-->
    <rule id="92108" level="10" overwrite="yes">
    <if_group>sysmon_event3</if_group>
    <field name="win.eventdata.destinationPort" type="pcre2">3389</field>
    <options>no_full_log</options>
    <description>Se detectó actividad de red del puerto RDP desde $(win.eventdata.sourceIp) hacia $(win.eventdata.destinationIp)</description>
    <mitre>
      <id>T1021.001</id>
    </mitre>
  </rule>
  
  Esta regla lo que hace es generar otro evento si las ips que se conectan son las acostumbradas. Caso contrario se genera la alerta de arriba
  Seguir incluyendo las ips habituales
  <rule id="101129" level="3">
    <if_sid>92108</if_sid>
    <field name="win.eventdata.destinationIp">^10.10.10.127$</field>
    <field name="win.eventdata.sourceIp">10.10.22.53$|^10.202.101.188$|^10.111.114.51$|^10.10.22.53$|^10.111.11.14$|^10.10.40.5$|^10.10.20.29$|^10.10.10.30$|^10.10.22.106$|^10.10.12.32$|^10.202.101.188$|^10.111.114.51$|^10.10.20.30$|^10.111.13.21$|^10.22.57.199$|^10.10.12.226$|^10.10.20.18$|^10.122.0.105$|^10.111.13.9$|^10.111.13.2$|^10.111.12.36$|^10.122.0.80$|^10.10.54.12$|^10.200.100.51$|^10.200.100.53$|^10.122.0.35$|^10.111.12.8$|^10.212.134.54$|^10.122.0.131$|^10.10.30.41$|^10.10.10.71$|^10.122.0.96$|^10.10.50.21$|^10.202.102.41$|^10.10.20.107$|^192.168.2.50$|^10.10.22.12$|^10.200.100.8$|^10.10.10.144$|^10.200.100.54$|^10.10.50.23$|^10.10.30.202$|^10.10.20.38$|^10.10.12.110$|^10.22.30.105$|^10.10.10.55$|^10.10.20.120$|^10.10.10.27$|^10.111.12.37$|^10.200.100.2$|^10.10.30.11$|^10.10.10.37$|^10.202.102.32$|^10.122.0.103$|^10.202.102.40$|^10.10.10.23$|^10.10.60.6$|^10.200.100.32$|^10.111.114.21$|^10.10.60.5$|^10.202.101.17$|^10.10.57.22$|^10.122.0.145$|^10.10.15.25$|^10.10.20.154$|^10.202.102.15$|^10.111.15.32$|^10.110.15.8$|^10.10.10.10$|^10.10.10.43$|^10.10.40.7$|^10.10.30.13$|^10.10.22.43$|^10.202.103.10$|^10.10.10.24$|^10.111.13.4$|^10.10.20.176$|^10.111.12.10$|^10.122.0.29$|^10.111.13.6$|^10.10.10.68$|^10.10.22.128$|^10.10.57.11$|^10.10.20.124$|^10.10.30.40$|^10.111.13.11$|^10.10.10.145$|^10.122.0.215$|^10.10.22.64$|^10.10.90.11$|^10.10.10.64$|^10.122.0.78$|^10.10.10.104$10.111.13.5$|^10.111.12.11$|^10.111.114.55$|^10.111.13.31$|^10.111.11.8$|^10.10.52.22$|^10.10.52.13$|^10.10.10.22$|^10.200.104.7$|^10.10.60.3$|^10.10.51.14$|10.10.20.48$|^10.10.10.46$</field>
    <description>Conexión RDP usuarios habituales a SERVERARP18</description>
  </rule>
  
  <!--Utilizo como referencia estas reglas para crear la que detecte un escaneo de puertos-->
  <!--En la regla inicial se niega que sea una autenticacion interna(localhost) y en cambio puede ser cualquier ip-->
    <rule id="92651" level="0">
    <if_sid>60106</if_sid>
    <field name="win.eventdata.ipAddress" type="pcre2">(?:[0-9]{1,3}\.){3}[0-9]{1,3}</field>
    <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">127\.0\.0\.1</field>
    <description>Successful Remote Logon by user:$(win.eventdata.targetDomainName)\$(win.eventdata.targetUserName) from $(win.eventdata.ipAddress).</description>
    <mitre>
      <id>T1078</id>
    </mitre>
    <group>authentication_success,gdpr_IV_32.2,gpg13_7.1,gpg13_7.2,hipaa_164.312.b,nist_800_53_AC.7,nist_800_53_AU.14,pci_dss_10.2.5,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!--En la segunda regla se especifica el paquete de autenticacion NTLM-->
  <!--Durante un escaneo de puertos, ésta es el evento que se genera por cada intento de conexión a un puerto-->
  <!-- <rule id="92652" level="6">-->
  <!--  <if_sid>92651</if_sid>-->
  <!--  <field name="win.eventdata.authenticationPackageName" type="pcre2">NTLM</field>-->
  <!--  <description>Successful Remote Logon Detected - User:$(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) - NTLM authentication, possible pass-the-hash attack.</description>-->
  <!--  <mitre>-->
  <!--    <id>T1550.002</id>-->
  <!--    <id>T1078.002</id>-->
  <!--  </mitre>-->
  <!--  <group>authentication_success,gdpr_IV_32.2,gpg13_7.1,gpg13_7.2,hipaa_164.312.b,nist_800_53_AC.7,nist_800_53_AU.14,pci_dss_10.2.5,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>-->
  <!--</rule>-->
  
  <!--para inicios de sesion anonimas el valor del Dominio es siempre NT AUTHORITY-->
<!--regla 92652 "Successful Remote Logon Detected 
    10.10.10.117 pertenece a SERVERAP, genera muchos eventos de conexion propios del sistema-->
  <rule id="101130" level="14">
    <if_sid>92652</if_sid>
    <field name="win.eventdata.targetDomainName">^NT AUTHORITY$</field>
    <field name="win.eventdata.targetUserName">ANONYMOUS LOGON</field>
    <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">^10.10.10.146$|^10.10.10.136$</field>
    <description>Inicio de sesion anonimo desde IP: $(win.eventdata.ipAddress) Estacion: $(win.eventdata.workstationName)</description>
  </rule>
  
  <!--volver a ajustar esta regla ya que para algunos endpoints solo se generaron 3 conexiones como resultado del escaneo-->
  <rule id="101131" level="15" frequency="11" timeframe="1600">
    <if_matched_sid>101130</if_matched_sid>
    <same_field>win.eventdata.ipAddress</same_field>
    <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">^10.10.10.117$|^10.122.0.148$|10.10.10.127$|10.10.10.136$</field>
    <description>ATENCION. Varias conexiones anonimas exitosas desde una misma IP en un periodo de tiempo muy corto. IP $(win.eventdata.ipAddress) </description>
  </rule>
  
  <!--<rule id="101132" level="3">-->
  <!--  <if_sid>101130</if_sid>-->
  <!--  <field name="win.eventdata.targetUserName"></field>-->
  <!--  <description>Conexion entre servidor y estacion de trabajo habitual.</description>-->
  <!--</rule>-->


<!--    <field name="win.eventdata.authenticationPackageName" type="pcre2">NTLM</field>-->
<!--    <description>Successful Remote Logon Detected - User:$(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) - NTLM authentication, possible pass-the-hash attack.</description>-->
  <!--******************************Esta regla detecta la conexion desde una misma ip a otra ip por distintos puertos de origen-->
  <!--La regla 92652 "Successful Remote Logon Detected - User:\cuenta/Usuario - NTLM authentication, possible pass-the-hash attack" detecta en su logon Type3 las conexiones exitosas hacia un destino, en base a esos eventos se crea la siguiente regla: el escaneo genera una frecuencia de 53 eventos dentro de una franja de 15 minutos
  Esta regla tiene como parametros una frecuencia de 20 eventos en 4 minutos pero a diferencia de la regla 92652 que no especifica si la cuenta de inicio de sesion es anonima en esta si la recalco porque son los eventos que genera un escaneo de vulnerabilidades. Varias conexiones exitosas desde una misma ip y sin proporcionar credenciales especificas-->
  <!--<rule id="101133" level="15">-->
  <!--  <if_sid>92652</if_sid>-->
  <!--  <field name="win.eventdata.targetUserName">ANONYMOUS LOGON</field>-->
  <!--  <field name="win.eventdata.targetDomainName">NT AUTHORITY</field>-->
  <!--  <field name="win.eventdata.workstationName" type="pcre2">\.+</field>-->
  <!--  <description>Inicio de sesion Anonimo desde IP $(win.eventdata.ipAddress) Puerto $(win.eventdata.ipPort). Estacion:$(win.eventdata.workstationName)</description>-->
  <!--</rule>-->
  
  	<!--***********************************************INICIO BLOQUE DE SERVICIOS *****************************************-->
	<!--NOTA: la regla 61138(local_rules) de "Servicio de Windows instalado" debe confundirse con "Cambio de configuracion de servicio existente" ya que 61138 no tiene la etiqueta ruleName en sus logs, sino el evento 7045 y mitre id T1543.003. 
	En cambio el evento de cambio de configuracion lo detecta sysmon Event 1, id 101101 de "Creación de proceso" y a partir de su etiqueta ruleName: "technique_id=T1031,technique_name=Modify Existing Service" con la imagen sc.exe (sc config) 
	Se van segmentando a continuación los diferentes cambios en config de servicios ya existentes-->
    <!--sc.exe es el responsable de iniciar, crear o cambiar valores especificos de los servicios, tener un control sobre este ejecutable es más que necesario-->
    <!--Esta alerta (102056) se generará cada vez que un servicio NO CONOCIDO por el administrador(yo) sea creado, iniciado o alterado a través del sc.exe , mas abajo se van a ir identificando y separando en otras reglas los procesos relacionados a éste los cuales serán alertados al principio con otro tipo de mensaje para su control y análisis.  ***
    Regla original de SYSMON= Creacion de proceso - rule id 101101-->
    <!--
	<rule id="102056" level="15">
	    <if_sid>101101</if_sid>
	    <field name="win.eventdata.image">C:\\Windows\\System32\\sc.exe$|C:\\\\Windows\\\\System32\\\\sc.exe$|C:\Windows\System32\sc.exe$</field>
	    <field name="win.eventdata.commandLine">\.+</field>
	    <description>Cambio de configuración de servicio. Comando: $(win.eventdata.commandLine)</description>
	</rule>
	-->
	<rule id="101134" level="15">
	    <if_sid>101101</if_sid>
	    <field name="win.eventdata.commandLine">\s*sc\s*config\s*</field>
	    <field name="win.eventdata.parentImage">^C:\\\\Windows\\\\System32\\\\cmd.exe$</field>
	    <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\sc.exe$</field>
	    <field name="win.eventdata.parentUser" type="pcre2" negate="yes">^NT AUTHORITY\\\\SYSTEM$</field>
	    <description>ATENCIÓN. Se ha ejecutado sc config . Cadena completa: $(win.eventdata.commandLine)</description>
	</rule>
	
	<!--Los parametros de las etiquetas parentCommandLine y parentImage indica que se ejecuta un servicio a través de una tarea programada del sistema--> 
	<!--la regla 102058 va generar el evento cada vez que el sistema, mediante svchost inicie un servicio existente con determinados argumentos los cuales se iran identificando mas abajo para posteriormente luego tener identificado cada cambio de config de servicio "normal"-->
	<rule id="101135" level="15">
	    <if_sid>101101</if_sid>
	    <field name="win.eventdata.parentImage">^C:\\\\Windows\\\\System32\\\\svchost.exe$</field>
	    <field name="win.eventdata.parentCommandLine">^C:\\\\WINDOWS\\\\system32\\\\svchost.exe -k netsvcs -p -s Schedule</field>
	    <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\sc.exe$</field>
	    <field name="win.eventdata.originalFileName">^sc.exe$</field>
	    <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM|NT AUTHORITY\\\\SERVICIO LOCAL</field>
	    <field name="win.eventdata.user">^NT AUTHORITY\\\\SERVICIO LOCAL</field>
	    <description>Cambio de configuración servicio ejecutado por SYSTEM. Comando $(win.eventdata.commandLine)</description>
	</rule>
	<!--Desde aquí se van subdividiendo o recategorizando los servicios que SYSTEM inicia automáticamente a partir de la regla 102058-->
	<!--servicio 1 de System-->
	<rule id="101136" level="0">
	    <if_sid>101135</if_sid>
	    <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\sc.exe\\" start w32time task_started|C:\\\\Windows\\\\system32\\\\sc.exe start w32time task_started</field>
	    <description>$(win.eventdata.commandLine). Este servicio se inicia automáticamente. Servicio de Windows Time, responsable de mantener y sincronizar la hora del sistema en un sistema Windows</description>
	</rule>
	<!--servicio 2 de System-->
	<rule id="101137" level="0">
	    <if_sid>101135</if_sid>
	    <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\sc.exe\\" start pushtoinstall registration</field> 
	    <description>$(win.eventdata.commandLine). Proporciona soporte de infraestructura para Microsoft Store. Este servicio se inicia automáticamente y, si se desactiva, las instalaciones remotas no funcionarán correctamente.</description>
	</rule>
	<!--Servicio 3 de System-->
	<rule id="101138" level="0">
	    <if_sid>101135</if_sid>
	    <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\sc.exe\\" start wuauserv</field>
        <description>$(win.eventdata.commandLine). El servicio "wuauserv" (Windows Update AutoUpdate Service) es esencial para la descarga e instalación de actualizaciones del sistema operativo y otros componentes de software en un sistema Windows.</description>
	</rule>
    <!--***********************************************FIN BLOQUE DE SERVICIOS *****************************************-->
    
</group>

<group name="sysmon,sysmon_eid11_detections,windows,">
   <rule id="92213" level="13" overwrite="yes">
        <if_group>sysmon_event_11</if_group>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Local\\\\Temp\\\\.+\.(exe|com|dll|vbs|js|bat|cmd|pif|wsh|ps1|msi|vbe)</field>
        <options>no_full_log</options>
        <description>Archivo ejecutable colocado en una carpeta comúnmente utilizada por malware.</description>
        <mitre>
            <id>T1105</id>
        </mitre>
    </rule>
    
   <!-- Renzo: Regla dada de baja, es reiterativa ante la ejecución de archivos ejecutables mediante powershell. Ya existe la regla principal -->
   
    <!--Segmentando Creacion de archivo, id 11. Powershell-->
    <!-- <rule id="101139" level="14">
        <if_sid>92213</if_sid>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Local\\\\Temp\\\\.+\.ps1</field>
        <field name="win.eventdata.user">\.+</field>
        <description>Powershell.exe ha sido ejecutado por usuario $(win.eventdata.user)</description>
    </rule> -->
    
    <rule id="92214" level="14" overwrite="yes">
      <if_group>sysmon_event_11</if_group>
      <field name="win.eventdata.image" type="pcre2">(?i)(winword|excel|powerpnt|outlook)\.exe</field>
      <field name="win.eventdata.targetFilename" type="pcre2">(?i)appdata\\\\.+\.lnk</field>
      <options>no_full_log</options>
      <description>Suspicious file created by Microsoft Office process: $(win.eventdata.image) created $(win.eventdata.targetFilename)</description>
      <mitre>
        <id>T1027</id>
      </mitre>
  </rule>
    
    <rule id="101140" level="3">
        <if_sid>92213</if_sid>
        <field name="win.eventdata.image" type="pcre2">(?i)[c-z]:\\\\Windows\\\\Application Compatibility Scripts\\\\acregl.exe$</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Local\\\\Temp\\\\.+\\\\getpaths.cmd</field>
        <field name="win.eventdata.user">GRUPOTOYOTOSHI\\\\(.+)</field>
        <description>Proceso para compatibilidad de programas antiguos para versiones nuevas de Windows. Usuario $(win.eventdata.user)</description>
    </rule>
    
    <!--Reglas personalizadas Network Connection. Sysmon Event 3, rule id 101103-->
	<rule id="101141" level="0">
	    <if_sid>101103</if_sid>
	    <field name="win.eventdata.user">GRUPOTOYOTOSHI\\\\jjbenitez$</field>
	    <description>Java ejecutado por usuario JJBenitez, esta alerta no se muestra</description>
	</rule>
	
	<rule id="101142" level="0">
	    <if_sid>101103</if_sid>
	    <field name="win.eventdata.image">\\\\Oracle\\\\Java</field>
	    <description>Java.exe ejecutado por Oracle</description>
	</rule>
    
    <!--<rule id="101143" level="14">-->
    <!--    <if_sid>101103</if_sid>-->
    <!--    <field name="win.system.eventID">^1149$</field>-->
    <!--    <description>Conexion detectada</description>-->
    <!--</rule>-->
    
</group>
<group name="windows,">
    <rule id="101144" level="0">
        <if_sid>60000</if_sid>
        <field name="win.system.channel">^Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational$</field>
        <options>no_full_log</options>
        <description>Grupo de eventos de conexiones remotas</description>
    </rule>
    <rule id="101145" level="0">
        <if_sid>60009</if_sid>
        <field name="win.system.channel">^Microsoft-Windows-TerminalServices-LocalSessionManager/Operational$</field>
        <options>no_full_log</options>
        <description>Grupo de eventos de conexiones remotas</description>
    </rule>
    <rule id="101146" level="3">
        <if_sid>60009</if_sid>
        <field name="win.system.eventID">^21$|^22$|^24$|^25$</field>
        <description>Grupo de eventos de conexiones</description>
    </rule>
    <rule id="101147" level="14">
        <if_sid>101146</if_sid>
        <field name="win.system.eventID">^25$</field>
        <field name="win.eventXML.address" type="pcre2">\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}</field>
        <field name="win.eventXML.address" type="pcre2" negate="yes">^LOCAL$</field>
        <description>ATENCION. Reconexion remota desde IP $(win.eventXML.address)</description>
    </rule>
    
    <rule id="101148" level="10">
        <if_sid>60009</if_sid>
        <field name="win.system.eventID">^261$|^1149$</field>
        <options>no_full_log</options>
        <description>La escucha RDP-Tcp recibió una conexión</description>
    </rule>
    <rule id="101149" level="14">
        <if_sid>101137</if_sid>
        <field name="win.system.eventID">$261$</field>
        <description>Se recibio una conexion mediante RDP-Tcp</description>
    </rule>
    <rule id="101150" level="14">
        <if_sid>101148</if_sid>
        <field name="win.system.eventID">^1149$</field>
        <description>ATENCIÓN. Escritorio Remoto ha sido iniciado por $(win.eventXML.param1) desde ip $(win.eventXML.param3)</description>
    </rule>
    
    <rule id="101153" level="3">
        <if_sid>101150</if_sid>
        <field name="win.eventXML.param1">^CRAMIREZ$|^LAYALA3$|^BMENCIA$</field>
        <description>Conexión RDP habitual iniciado por $(win.eventXML.param1) desde ip $(win.eventXML.param3)</description>
    </rule>
    
    <!--rdpclip.exe-->
    <rule id="101151" level="14">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">rdpclip</field>
        <field name="win.eventdata.image" type="pcre2">(?i)[c-z]:\\\\Windows\\\\System32\\\\rdpclip.exe$</field>
        <description>RDP Clipboard Monitor esta siendo utilizado</description>
    </rule>
    <!--Cambio de Registro de Windows-->
    <rule id="101152" level="15">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.targetObject">^HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit$|^HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell$|^HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Notify$|^HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\Winlogon\\\\Shell$|^HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Notify$|^HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit$</field>
        <description>ATENCION. Cambio en el registro de Windows</description>
    </rule>
    
    <!--Subcategorias de evento 13 Evento de registro de Sysmon, id 101113-->
    <rule id="101154" level="0">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.details">Tee/Sink-to-Sink Converter</field>
        <field name="win.eventdata.ruleName">Context,DeviceConnectedOrUpdated</field>
        <description>El convertidor Tee/Sink-to-Sink es un filtro basado en KsProxy en modo kernel. Se utiliza en gráficos de filtro de televisión de vídeo analógico donde se procesan o capturan datos de VBI.</description>
    </rule>
    <rule id="101155" level="0">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.details">Microsoft Trusted Audio Drivers</field>
        <field name="win.eventdata.ruleName">Context,DeviceConnectedOrUpdated</field>
        <description>Eventos relacionados a Audio Drivers de Microsoft.</description>
    </rule>
    
    <!--Subgategorias de Evento 1 de Sysmon, Creación de proceso-->
    <rule id="101156" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">taskhostw.exe ExploitGuardPolicy</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">^C:\\\\Windows\\\\system32\\\\svchost.exe -k netsvcs -p</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\svchost.exe</field>
        <description>Host Process for Windows Tasks. Politicas de ExploitGuard de Windows Defender ejecutado por SYSTEM</description>
    </rule>
    <rule id="101157" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">C:\\\\Windows\\\\System32\\\\Upfc.exe /launchtype boot /cv ryb+2UhYXUWwX5mOzoWsnQ.0</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\upfc.exe$</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>Upfc.exe ejecutado por SYSTEM. Este software asociado se utiliza principalmente para administrar actualizaciones y parches para el sistema operativo Windows. Ayuda a mantener la estabilidad y seguridad del sistema al garantizar que todos los componentes del sistema operativo estén actualizados. </description>
    </rule>
    <rule id="101158" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\dxgiadaptercache.exe\\"</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.description">^DXGI Adapter Cache$</field>
        <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\dxgiadaptercache.exe</field>
        <field name="win.eventdata.originalFileName">^DXGIAdapterCache.exe$</field>
        <field name="data.win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\svchost.exe -k netsvcs -p$</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\svchost.exe$</field>
        <field name="win.eventdata.parentUser">^NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.product">^Microsoft® Windows® Operating System$</field>
        <field name="win.eventdata.user">^NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Proceso ejecutado por System</description>
    </rule>
     <rule id="101158" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">C:\\\\Windows\\\\System32\\\\spoolsv.exe</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\spoolsv.exe$</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.product">^Microsoft® Windows® Operating System$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>Spoolsv.exe es el principal servicio de "spooling" de la impresora en Windows 2000 y sucesivos. Es responsable de gestionar todos los trabajos de impresión en el ordenador. El "spooling" es un proceso que permite que el sistema operativo ponga en cola trabajos de impresión, para que éstos puedan completarse en segundo plano, en vez de forzar al usuario a esperar mientras la impresión finaliza. Es un servicio esencial de cualquier trabajo de impresora o fax.</description>
    </rule>
    
     <rule id="101159" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\Users\\\\.+\\\\AppData\\\\Local\\\\Wondershare\\\\Wondershare\s+NativePush\\\\WsNativePushService.exe\\"</field>
        <field name="win.eventdata.company">^Wondershare$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.originalFileName">NativePushService.exe</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">^C:\\\\Users\\\\.+\\\\AppData\\Local\\\\Wondershare\\\\Wondershare\s+NativePush\\\\WsNativePushService.exe</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.product">^Wondershare NativePush$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>La función principal de WsNativePushService.exe es proporcionar notificaciones automáticas y actualizaciones relacionadas con los productos Wondershare. Ayuda a mantener actualizado su software Wondershare descargando e instalando automáticamente las últimas actualizaciones. Esto garantiza que siempre tendrá las últimas funciones y parches de seguridad.</description>
    </rule>
    <rule id="101160" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\\"</field>
        <field name="win.eventdata.company">^MingW-W64\s+Project. All rights reserved.$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.originalFileName">WinPthreadGC</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">^C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description): Proceso del agente de Wazuh. POSIX Threads, comúnmente conocido como pthreads, es un modelo de ejecución que existe independientemente de un lenguaje de programación, así como un modelo de ejecución paralela . Permite que un programa controle múltiples flujos de trabajo diferentes que se superponen en el tiempo.</description>
    </rule>
    <rule id="101161" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe\\"</field>
        <field name="win.eventdata.company">^MingW-W64\s+Project. All rights reserved.$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.description">Antimalware Service Executable</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">^C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe</field>
        <field name="win.eventdata.originalFileName">MsMpEng.exe</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Proceso de seguridad de Windows que ejecuta protección en tiempo real contra malware . También conocido como msmpeng.exe, el proceso ejecutable del servicio antimalware de Windows se ejecuta en segundo plano, por lo que puede escanear archivos y programas de vez en cuando. </description>
    </rule>
    
    <rule id="101162" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">C:\\\\Windows\\\\Sysmon64.exe</field>
        <field name="win.eventdata.company">^Sysinternals\s+-\s+www.sysinternals.com$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\services.exe</field>
        <field name="win.eventdata.image">sysmon64.exe$</field>
        <field name="win.eventdata.product">Sysinternals\d+Sysmon</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Proceso de Sysmon</description>
    </rule>
    
     <rule id="101163" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\wevtutil.exe\\s+uninstall-manifest\s+\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\Microsoft-Antimalware-AMFilter.man\\"</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe\\"</field>
        <field name="win.eventdata.parentImage">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Este proceso es normal, wevtutil elimina el manifiesto anterior para crear otro limpio.</description>
    </rule>
    <rule id="101164" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\wevtutil.exe\s+install-manifest\s+\\\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\Microsoft-Antimalware-AMFilter.man\\" \\"/resourceFilePath:C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\Drivers\\\\WdFilter.sys\\"\s+\\"/messageFilePath:C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\Drivers\\\\WdFilter.sys\\"\s+\\"/parameterFilePath:C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\Drivers\\\\WdFilter.sys\\"</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe\\"</field>
        <field name="win.eventdata.parentImage">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Este proceso es normal, wevtutil vuelve a crear un manifiesto limpio</description>
    </rule>
    
    <rule id="101165" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\ClipRenew.exe\\"\d+-e</field>
        <field name="win.eventdata.company">^Microsoft Corporation$</field>
        <field name="win.eventdata.currentDirectory">^C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\ClipRenew.exe$</field>
        <field name="win.eventdata.originalFileName">^ClipRenew.exe$</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\svchost.exe -k netsvcs -p</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\svchost.exe</field>
        <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). ClipRenew.exe es parte del sistema operativo Microsoft® Windows® desarrollado por Microsoft Corporation. Este archivo es una parte importante del sistema operativo Windows.
.</description>
    </rule>
    
    <rule id="101166" level="0">
        <if_sid>101101</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MpCmdRun.exe\\" -IdleTask -TaskName WdVerification</field>
        <field name="win.eventdata.company">Microsoft Corporation</field>
        <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
        <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\svchost.exe -k netsvcs -p</field>
        <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\svchost.exe</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>$(win.eventdata.description). Esta utilidad es útil cuando desea automatizar las tareas de Microsoft Defender Antivirus</description>
    </rule>
    
    <!--Cambios tipicos del Registro de Windows-->
    <!--NetworkList-->
    <!--Evento 13, id 101113 Sysmon-->
    <rule id="101167" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\ProfileName</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\ProfileName: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101168" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\Description</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Description: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101169" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\Managed</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Managed: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101170" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\Category</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Category: $(win.eventdata.details).</description>
    </rule>
    
     <rule id="101171" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\DateCreated</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\DateCreated: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101172" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\DateLastConnected</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\DateLastConnected: $(win.eventdata.details).</description>
    </rule>
    
     <rule id="101173" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\NetworkList\\\\Profiles\\\\.+\\\\NameType</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows NetworkList: Valor asignado a HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\NameType: $(win.eventdata.details).</description>
    </rule>
    <!--Valores de Registro de Windows Defender-->
    <rule id="101174" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\OwningPublisher</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado OwningPublisher: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101175" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\Enabled</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado Enabled: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101176" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\Isolation</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado Isolation: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101177" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\ChannelAccess</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado ChannelAccess: $(win.eventdata.details).</description>
    </rule>
    
     <rule id="101178" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\MaxSize</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado MaxSize: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101179" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\MaxSizeUpper</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado MaxSizeUpper: $(win.eventdata.details).</description>
    </rule>
    
     <rule id="101180" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\OwningPublisher</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC OwningPublisher: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101181" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/Operational\\\\Type</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado Type: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101182" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\Enabled</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC Enabled: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101183" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\Isolation</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC Isolation: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101184" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\ChannelAccess</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC ChannelAccess: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101185" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\MaxSize</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC MaxSize: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101186" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\MaxSizeUpper</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC MaxSizeUpper: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101187" level="3">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\wevtutil.exe$</field>
        <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\WINEVT\\\\Channels\\\\Microsoft-Windows-Windows Defender/WHC\\\\Type</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SERVICIO LOCAL</field>
        <description>Evento de Registro de Windows - Windows Defender: Valor asignado WHC Type: $(win.eventdata.details).</description>
    </rule>
    
    <rule id="101188" level="10">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">^C:\\\\Windows\\\\system32\\\\LogonUI.exe$</field>
        <field name="win.eventdata.details">^00000409$</field>
        <field name="win.eventdata.targetObject">HKU\\\\.DEFAULT\\\\Keyboard Layout\\\\Preload\\\\1</field>
        <field name="win.eventdata.eventType">^SetValue$</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>Evento de Registro de Windows - Configuración de diseño de teclado predeterminada para nuevos usuarios. El valor 00000409 representa un identificador de diseño de teclado específico, en este caso, el identificador 0409 corresponde al diseño de teclado estándar de Estados Unidos.</description>
    </rule>
    
    <!--Discovery activity executed rule id 92031-->
    <!--excluir discovery de ossec-->
    <rule id="101189" level="0">
        <if_sid>92031</if_sid>
        <field name="win.eventdata.commandLine">net.exe accounts</field>
        <field name="win.eventdata.company">Microsoft Corporation</field>
        <field name="win.eventdata.currentDirectory">C:\\\\Program Files (x86)\\\\ossec-agent</field>
        <field name="win.eventdata.description">Net Command</field>
        <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\net.exe</field>
        <field name="win.eventdata.originalFileName">^net.exe$</field>
        <field name="win.eventdata.parentCommandLine">\\"C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\\"</field>
        <field name="win.eventdata.parentImage">C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe</field>
        <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
        <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
        <description>Wazuh agent inicia monitoreo de politicas de seguridad del sistema. Comando ejecutado por el agente: $(win.eventdata.commandLine)</description>
    </rule>
  <!--Mas sobre Creación de procesos-->
  <rule id="101190" level="10">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\wbem\\\\unsecapp.exe -Embedding</field>
    <field name="win.eventdata.company">Microsoft Corporation</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\wbem\\\\unsecapp.exe</field>
    <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\svchost.exe -k DcomLaunch -p</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\svchost.exe</field>
    <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
    <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
    <field name="win.eventdata.originalFileName">unsecapp.dll</field>
    <description>Unsecapp.exe es un proceso del sistema relacionado con WMI, que es un conjunto de extensiones al sistema operativo Windows que brinda información de administración y configuración del sistema en el entorno operativo Windows.</description>
  </rule>
  <!--Registro de Windows Defender-->
  <rule id="101191" level="10">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.details">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MPUXAGENT.DLL</field>
    <field name="win.eventdata.eventType">SetValue</field>
    <field name="win.eventdata.image">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe</field>
    <field name="win.eventdata.ruleName">T1122</field>
    <field name="win.eventdata.targetObject">HKCR\\\\CLSID\\\\{.+}\\\\InprocServer32\\\\\(Default\)</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
    <description>Proceso de Motor de antivirus de Windows Defender. Valor asignado a HKCR\CLSID\InprocServer32\Default: MPUXAGENT.DLL. Este evento está relacionado con manipulación de extensiones de servidor COM. En este caso, la manipulación implica el establecimiento de un valor en el Registro asociado con el Motor de Antivirus de Windows Defender</description>
  </rule>
  
   <rule id="101192" level="10">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.eventType">SetValue</field>
    <field name="win.eventdata.image">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MsMpEng.exe</field>
    <field name="win.eventdata.targetObject">HKCR\\\\*\\\\shellex\\\\ContextMenuHandlers\\\\EPP\\\\\(Default\)</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
    <description>Proceso de Motor de antivirus de Windows Defender.  El proceso que realizó el cambio fue MsMpEng.exe. El valor que se estableció es {09A47860-11B0-4DA5-AFA5-26D86198A780} y se estableció en la clave de registro HKCR\\*\\shellex\\ContextMenuHandlers\\EPP\\(Default). 
La clave de registro HKCR\\*\\shellex\\ContextMenuHandlers\\EPP\\(Default) se utiliza para especificar el valor predeterminado de un controlador de contexto de menú.</description>
  </rule>
  <!--creacion de proceso-->
   <rule id="101193" level="0">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MpCmdRun.exe\\" SignatureUpdate -ScheduleJob -RestrictPrivileges</field>
    <field name="win.eventdata.company">Microsoft Corporation</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <field name="win.eventdata.image">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\+\\\\MpCmdRun.exe</field>
    <field name="win.eventdata.originalFileName">MpCmdRun.exe</field>
    <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
    <description>Proceso de Motor de antivirus de Windows Defender. $(win.eventdata.description)</description>
  </rule>
  <!--Evento de registro de valores-->
   <rule id="101194" level="0">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.commandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\MpCmdRun.exe\\" SignatureUpdate -ScheduleJob -RestrictPrivileges</field>
    <field name="win.eventdata.eventType">SetValue</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\services.exe</field>
    <field name="win.eventdata.ruleName">T1031,T1050</field>
    <field name="win.eventdata.targetObject">HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\WdNisDrv\\\\Start</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\SYSTEM</field>
    <description>Proceso de Motor de antivirus de Windows Defender. Inicio del servicio Windows Defender Network Inspection System (WdNisDrv).</description>
  </rule>
  <!--Proceso-->
   <rule id="101195" level="0">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">\\"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\NisSrv.exe\\"</field>
    <field name="win.eventdata.company">Microsoft Corporation</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <field name="win.eventdata.image">C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\.+\\\\NisSrv.exe</field>
    <field name="win.eventdata.originalFileName">NisSrv.exe</field>
    <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\services.exe</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\system32\\\\services.exe</field>
    <field name="win.eventdata.parentUser">NT AUTHORITY\\\\SYSTEM</field>
    <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
    <description>Proceso de Motor de antivirus de Windows Defender. $(win.eventdata.description)</description>
  </rule>
  
  <rule id="101196" level="0">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\System32\\\\SLUI.exe\\" RuleId=31e71c49-8da7-4a2f-ad92-45d98a1c79ba;Action=AutoActivate;AppId=.+;SkuId=.+;NotificationInterval=\d+;Trigger=TimerEvent</field>
    <field name="win.eventdata.company">Microsoft Corporation</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\slui.exe</field>
    <field name="win.eventdata.originalFileName">slui.exe</field>
    <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\system32\\\\SppExtComObj.exe -Embedding</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\SppExtComObj.Exe</field>
    <field name="win.eventdata.parentUser">NT AUTHORITY\\\\Servicio de red</field>
    <field name="win.eventdata.user">NT AUTHORITY\\\\Servicio de red</field>
    <field name="win.eventdata.product">Microsoft® Windows® Operating System</field>
    <description>Proceso de Windows: $(win.eventdata.description)</description>
  </rule>
  
  <!--Creacion y eliminacion de tareas programadas-->
  <rule id="101197" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\schtasks.exe /delete</field>
    <field name="win.eventdata.description">^Task Scheduler Configuration Tool$</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\schtasks.exe|schtasks.exe</field>
    <field name="win.eventdata.integrityLevel">System</field>
    <field name="win.eventdata.originalFileName">\.+</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <description>Se eliminó una tarea programada a través de SYSTEM. Imagen Original:$(win.eventdata.originalFileName). Comando:$(win.eventdata.commandLine)</description>
  </rule>
  <rule id="101198" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\schtasks.exe /Create</field>
    <field name="win.eventdata.description">^Task Scheduler Configuration Tool$</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\schtasks.exe|schtasks.exe</field>
    <field name="win.eventdata.integrityLevel">System</field>
    <field name="win.eventdata.originalFileName">\.+</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Windows\\\\system32</field>
    <description>Se creó una tarea programada a través de SYSTEM. Imagen Original:$(win.eventdata.originalFileName). Comando:$(win.eventdata.commandLine)</description>
  </rule>
  
  <rule id="101199" level="15">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\System32\\\\schtasks.exe\\" /Create</field>
    <field name="win.eventdata.description">^Task Scheduler Configuration Tool$</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\schtasks.exe|schtasks.exe</field>
    <field name="win.eventdata.originalFileName">\.+</field>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Windows\\\\system32</field>
    <description>ATENCION. Se creó una tarea programada en el directorio $(win.eventdata.currentDirectory). Comando: $(win.eventdata.commandLine)</description>
  </rule>
 
 <!--Sysmon tambien detecta una tarea programada en el evento FileCreated, especificando el directorio raiz podemos capturar ese evento-->
  <rule id="101201" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.image">C:\\\\Windows\\\\system32\\\\svchost.exe</field>
    <field name="win.eventdata.ruleName">T1053</field>
    <description>ATENCION. Evento 11 de Sysmon: Tarea programada creada: $(win.eventdata.targetFileName)</description>
  </rule>
  
  <!--Esta regla está basada en la creacion de procesos, excluyendo VBoxTray.exe -->
  <rule id="101202" level="14">
    <if_sid>101101</if_sid>
    <!--<field name="win.eventdata.commandLine">.exe|.bat</field>-->
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Windows\\\\SysWOW64|C:\\\\Windows\\\\System32</field>
    <field name="win.eventdata.parentCommandLine">C:\\\\Windows\\\\Explorer.EXE</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\explorer.exe</field>
    <field name="win.eventdata.description">App</field>
    <field name="win.eventdata.image" type="pcre2" negate="yes">C:\\\\Windows\\\\System32\\\\VBoxTray.exe$</field>
    <description>Ejecutable inciado por Explorer. Imagen principal: $(win.eventdata.image). Archivo Original: $(win.eventdata.originalFileName)</description>
  </rule>
  
  <!--Ejecutable iniciado por Explorer-->
  <rule id="101203" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">\.+</field>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Windows\\\\system32|C:\\\\Windows\\\\SysWOW64</field>
    <field name="win.eventdata.parentCommandLine" type="pcre2" negate="yes">C:\\\\Windows\\\\Explorer.EXE</field>
    <field name="win.eventdata.parentImage" type="pcre2" negate="yes">C:\\\\Windows\\\\explorer.exe</field>
    <field name="win.eventdata.description">App</field>
    <field name="win.eventdata.image">.exe|.bat</field>
    <description>ATENCION. Ejecutable $(win.eventdata.originalFileName) Imagen original: $(win.eventdata.image)</description>
  </rule>
  
  <!--excluir eventos de OneDrive-->
   <rule id="101204" level="0">
    <if_sid>101103</if_sid>
    <field name="win.eventdata.image">C:\\\\.+\\\\.+\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDriveStandaloneUpdater.exe</field>
    <field name="win.eventdata.destinationPort">443</field>
    <field name="win.eventdata.destinationPortName">https</field>
    <field name="win.eventdata.destinationIp">52.113.194.132</field>
    <description>Netowrk Connection iniciado por ONEDRIVE</description>
  </rule>
  
  <!--PRUEBA TODAVIA-->
  <!--<rule id="101205" level="14">-->
  <!--  <if_sid>101101</if_sid>-->
  <!--  <field name="win.eventdata.ruleName">technique_id=T1204,technique_name=User Execution</field>-->
  <!--   <field name="win.eventdata.image" eval="regex_extract_all(data.win.eventdata.image, '(\\w+\.exe)')[0]" />-->
  <!--  <description>User Execution: Imagen $(win.eventdata.commandLine) ejecutada por $(win.eventdata.image)</description>-->
  <!--</rule>-->
  
  <!--DETECTA EJECUCION-->
   <rule id="101206" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.commandLine">.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.msi|.jar|.pif|.scr</field>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Windows\\\\SysWOW64|C:\\\\Windows\\\\System32</field>
    <field name="win.eventdata.parentCommandLine">\.+</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\explorer.exe</field>
    <field name="win.eventdata.originalFileName">.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.msi|.jar|.pif|.scr</field>
    <field name="win.eventdata.image" type="pcre2" negate="yes">^C:\\\\Windows\\\\System32\\\\notepad.exe$</field>
    <description>Se ejecutó:$(win.eventdata.commandLine) por $(win.eventdata.parentUser) manualmente. </description>
  </rule>
  
  <!--detectar creacion de .bat etc-->
  <rule id="101207" level="14">
    <if_sid>92200</if_sid>
    <field name="win.eventdata.targetFileName">.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.msi|.jar|.pif|.scr</field>
    <field name="win.eventd ata.user" type="pcre2" negate="yes">C:\\\\Windows\\\\SysWOW64|C:\\\\Windows\\\\System32|NT AUTHORITY\\\\SYSTEM</field>
    <description>ATENCIÓN. Ejecutable creado. Imagen principal: $(win.eventdata.image). Archivo Original: $(win.eventdata.targetFileName)</description>
  </rule>
  
  <!-- Renzo: Cambié esta regla para que si se cumplen la 101119 (Ejecucion de PowerShell) o la 101126 (Ejecución de CMD), y a la vez se ejecuten scripts, salte el aviso personalizado-->
  <!-- Renzo: Toca probar esto, ya que al ejecutar scripts se utiliza cscript.exe como image y cmd.exe como parentImage en el caso de CMD. -->
  <rule id="101208" level="14">
    <if_sid>101119, 101126</if_sid>
    <field name="win.eventdata.commandLine">.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.msi|.jar|.pif|.scr</field>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Windows\\\\SysWOW64|C:\\\\Windows\\\\System32</field>
    <field name="win.eventdata.parentCommandLine">\.+</field>
    <field name="win.eventdata.originalFileName">.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.msi|.jar|.pif|.scr</field>
    <field name="win.eventdata.image" type="pcre2" negate="yes">^C:\\\\Windows\\\\System32\\\\notepad.exe$</field>
    <description>Se ejecutó:$(win.eventdata.commandLine) por $(win.eventdata.parentUser) mediante consola. </description>
  </rule>
  
  <!--Sigue en modo prueba, esta regla intenta detectar cuando un archivo es descomprimido y se genera otro archivo o directorio. Para poder entender mejor algunos procesos referentes a descargas-->
  <!--Las reglas 101208 y 101209 estan basadas en ruleName: Downloads, pero difieren ambas en el proceso responsable por ej. En el caso de las descompresiones el responsable de dicho proceso ya dentro del sistema es Explorer.Exe, en el caso de las descargas normales el proceso responsable puede ser un navegador mismo como el proceso msedge.exe de windows (EDGE)-->
  <rule id="101209" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.image">^C:\\\\Windows\\\\Explorer.EXE$</field>
    <field name="win.eventdata.ruleName">^Downloads$</field>
    <description>El explorador de Windows realizó la siguiente acción. Generación de $(win.eventdata.targetFileName)</description>
  </rule>
  
  <!--RDP derivacion de rule 101146-->
   <rule id="101210" level="14">
        <if_sid>101146</if_sid>
        <field name="win.system.eventID">^22$</field>
        <field name="win.eventXML.address" type="pcre2">\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}</field>
        <field name="win.eventXML.address" type="pcre2" negate="yes">^LOCAL$</field>
        <description>ATENCION. Servicios de Escritorio remoto: Notificación de inicio de Shell recibida</description>
    </rule>
    
    <!--Evento detectado por Sysmon eventID 1, rule id 101101 -->
   <rule id="101211" level="3">
      <if_sid>101101</if_sid>
      <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\WindowsPowerShell\\v1.0\\\\powershell.exe</field>
      <field name="win.eventdata.currentDirectory">C:\\\\Program Files (x86)\\\\ossec-agent</field>
      <field name="win.eventdata.parentImage">C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe</field>
      <field name="win.eventdata.ruleName">technique_id=T1086,technique_name=PowerShell</field>
      <description>Grupo de eventos de creación de procesos que realiza Wazuh Agent, este evento se genera con los eventos todavia categorizados</description>
  </rule>
  
  <!--Tambien recategorizando desde evento 92066, regla que analiza eventos de id1 a partir de parentImage powershell.exe e image (?i)Windows\\\\(SysWOW64|Temp).+\.exe-->
    <rule id="101212" level="0">
        <if_sid>92066</if_sid>
        <field name="win.eventdata.commandLine">\\"C:\\\\Windows\\\\system32\\\\SecEdit.exe\\" /export /cfg C:\\\\Windows\\\\TEMP/secexport.cfg</field>
        <field name="win.eventdata.parentCommandLine">powershell \\"\$null = secedit /export /cfg \$env:temp/secexport.cfg; \$\(gc \$env:temp/secexport.cfg | Select-String \\\\\\"LSAAnonymousNameLookup\\\\\\"\).ToString\(\).Split\(\\\\\\"=\\\\\\"\)[1].Trim\(\)\\"</field>
        <description>Eventos de Wazuh-Agent.: Agente verificando configuración LSA del sistema. 1 permite resolución de nombres anónimos para acceso a recursos, 0 no</description>
    </rule>
  
    <rule id="101213" level="0">
    <if_sid>101211</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">powershell \\\"\$null = secedit /export /cfg \$env:temp/secexport.cfg; \$\(gc \$env:temp/secexport.cfg | Select-String \\\\\\\"LSAAnonymousNameLookup\\\\\\\"\).ToString\(\).Split\(\\\\\\\"=\\\\\\\"\)[1].Trim\(\)\\\"</field>
    <description>Eventos de Wazuh-Agent: Agente verificando configuración LSA del sistema. 1 permite resolución de nombres anónimos para acceso a recursos, 0 no</description>
  </rule>
  
   <rule id="101214" level="14">
    <if_sid>92031</if_sid>
    <field name="win.eventdata.commandLine">C:\\\\Windows\\\\system32\\\\net1|C:\\\\Windows\\\\system32\\\\net</field>
    <field name="win.eventdata.description">Net Command</field>
    <field name="win.eventdata.image">C:\\\\Windows\\\\SysWOW64\\\\net1.exe|C:\\\\Windows\\\\System32\\\\net1.exe|C:\\\\Windows\\\\SysWOW64\\\\net.exe|C:\\\\Windows\\\\SysWOW64\\\\net1.exe</field>
    <field name="win.eventdata.currentDirectory">C:\\\\Program Files (x86)\\\\ossec-agent</field>
    <description>Ossec detectó actividad en el sistema. Comando $(win.eventdata.commandLine) ejecutado en el sistema</description>
  </rule>
  
  
  <!--101215 libre-->
  
  
  <!--Le regla 101148 del eventID 261: La escucha RDP-Tcp recibió una conexión
  100 intentos de conexion en 60 segundos-->
  <rule id="101216" level="15" frequency="100" timeframe="60">
    <if_matched_sid>101148</if_matched_sid>
    <same_field>win.system.eventID</same_field>
    <description>ATENCION. La escucha Tcp-Rdp recibió una cantidad inusual de paquetes de conexión al puerto 3389 (100 intentos de conexion en 60 segundos) Posible escaneo </description>
  </rule>
  
  
  
  <!--NETWORK CONNECTION TOYOTOSHI-->
   <!--10.110.8.4 SERVERAPFACTE, esta conexion es un proceso normal y aparentemente aloja a su sitio web(Conexion iniciada desde un equipo hacia 10.110.8.4) 30mil eventos al dia aproximadamente-->
   <!--SERVERLAB es quien realiza estas conexiones-->
 <rule id="101217" level="0">
    <if_sid>101103</if_sid>
    <field name="win.eventdata.destinationIp">^10.110.8.4$</field>
    <field name="win.eventdata.ruleName">^technique_id=T1043,technique_name=Commonly Used Port$</field>
    <field name="agent.name">^SERVERLAB$</field>
    <description>Network Connection habitual y normal</description>
 </rule>
  
  <!--el evento "archivo colocado en una carpeta comunmente utilizada por malware" id 92213 genera el evento cuando a través de Explorer.exe se crea un archivo en este caso en el directorio Tmp
  Este evento se genera mas que nada al iniciar el instalador de FTK Imager.-->
  <!--C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\3c78d5d4-b968-44ba-9469-94932d0a0699_AccessData FTK Imager 3-3-0.zip.699\\AccessData FTK Imager 3-3-0.exe-->
  <rule id="101218" level="14">
    <if_sid>92213</if_sid>
    <field name="win.eventdata.targetFilename">AccessData FTK Imager \.+.exe$</field>
    <field name="win.eventdata.image">Explorer.EXE$</field>
    <description>ATENCIÓN. Instalación de AccessData FTK Imager detectado</description>
  </rule>
  
  <!--Sysmon - Event 2: A process changed a file creation time. Tambien detecta el cambio de tiempo de creacion de un archivo, en este caso tambien al ejecutarse el instalador son generados casi al mismo tiempo estos primeros dos eventos
  En image estaba Exolorer.EXE pero como no se si este evento puede producirse bajo otro proceso lo dejo sin la condición-->
   <rule id="101219" level="14">
    <if_sid>101102</if_sid>
    <field name="win.eventdata.targetFilename">AccessData FTK Imager \.+.exe$</field>
    <field name="win.eventdata.image">\.+</field>
    <description>ATENCIÓN. Un proceso cambió la fecha de creación de AccessData FTK Imager</description>
  </rule>
  
  <!--El evento 101101 de sysmon (creación de proceso) también detecta al AccesData FTK Imager cuando el proceso InstallShield Setup.exe toma los parámetros de la instalación-->
  <rule id="101220" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.product">AccessData FTK Imager</field>
    <field name="win.eventdata.image">AccessData FTK Imager \.+.exe$</field>
    <description>ATENCIÓN. Creación de proceso de instalación de AccessData FTK Imager</description>
  </rule>
  
  <!--El evento 101113 de cambio en el registro mediante svchost.exe-->
  <!--Sysmon - Event 13: Evento de registro. Objeto: HKU\\S-1-5-21-566580211-2354884658-3898533425-500\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Compatibility Assistant\\Store\\C:\\Users\\Administrator\\AppData\\Local\\Temp\\3c78d5d4-b968-44ba-9469-94932d0a0699_AccessData FTK Imager 3-3-0.zip.699\\AccessData FTK Imager 3-3-0.exe-->
  <rule id="101222" level="14">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.targetObject">FTK Imager.exe$</field>
    <description>ATENCIÓN. Evento de registro generado por inicio de programa AccessData FTK Imager</description>
  </rule>
  
  <!--La misma regla va generando varios otras alertas de registro relacionadas a la herramienta en este caso en el inventario de Apps del sistema-->
  <!--<rule id="101223" level="14">-->
  <!--  <if_sid>101113</if_sid>-->
  <!--  <field name="win.eventdata.targetObject">InventoryApplicationFile\\\\accessdata ftk i</field>-->
  <!--  <description>ATENCIÓN. Evento de registro en InventoryApplicationFile de ftk</description>-->
  <!--</rule>-->
  
  <!--Tambien otro evento de creacion de proceso, en este caso como proceso responsable a msiexec.exe-->
  <rule id="101224" level="14">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.originalFileName">msiexec.exe$</field>
    <field name="win.eventdata.parentImage">AccessData FTK Imager \.+.exe$</field>
    <description>ATENCIÓN. Creación de proceso, msiexec.exe inició el proceso de instalción de AccessData FTK Imager</description>
  </rule>
  
  <!--Luego como resultado de ese proceso se empiezan a escribir las librerias dinamicas en progams files lo que genera muchos eventos por cada libreria-->
  <!--Sysmon - Event 11: FileCreate: C:\\Program Files (x86)\\AccessData\\FTK Imager\\ADIsoDLL.dll-->
   <rule id="101225" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">C:\\\\Program Files (x86)\\\\AccessData\\\\FTK Imager\\\\.+\\\\.+.dll</field>
    <field name="win.eventdata.ruleName">^DLL$</field>
    <description>ATENCIÓN. msiexec.exe ha colocado DLL en directorio FTK Imager.</description>
  </rule>
  
  <!--La regla con id 60612 del canal Application evento 11707 informa directamente que la herramienta FTK ha sido instalada de forma exitosa-->
  <rule id="101226" level="14">
    <if_sid>60612</if_sid>
    <field name="data.win.eventdata.data">Product: AccessData FTK Imager -- Installation operation completed successfully.</field>
    <field name="win.system.eventID">11707</field>
    <description>$(win.system.message)</description>
  </rule>
  
  <!--misma regla del canal o providerName MsiInstaler detecta que Windows Installer realizó la instalación de FTK-->
  <rule id="101227" level="14">
    <if_sid>60612</if_sid>
    <field name="data.win.eventdata.data">AccessData FTK Imager\.+</field>
    <field name="win.system.eventID">1033</field>
    <description>$(win.system.message)</description>
  </rule>
  
  <!--aparentemente al iniciar la copia de memoria RAM, el driver ad_driver.sys es ejecutado. Verificar como hacer match con los hashes que Wazuh obtiene del driver: MD5=3AED842C643DFDBCB2ED9E8E41E289FA,SHA256=9DF6669ED175D41014859C9CD09FD32F52F5E3315C50E614707E86CBD6DFA1B6,IMPHASH=BC5A91CC75B8EEDCB27D34B97C87000A-->
 <rule id="101228" level="14">
    <if_sid>101106</if_sid>
    <field name="win.eventdata.imageLoaded">ad_driver.sys$</field>
    <field name="win.eventdata.signature">AccessData</field>
    <description>ATENCIÓN. Controlador de disco y memoria AccessData inició un proceso en el sistema</description>
 </rule>
 
 <!--Sysmon - Event 11: FileCreate: C:\\Users\\Administrator\\Desktop\\capture2\\pagefile.sys-->
    <rule id="101229" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.image">C:\\\\Program Files (x86)\\\\AccessData\\\\FTK Imager\\\\FTK Imager.exe</field>
    <description>ATENCIÓN. Archivo creado por FTK Imager.</description>
 </rule>
 
 <!--la regla no reconoce los hashes-->
 Cuando se ejecuta el programa se genera este evento
 <rule id="101230" level="14">
    <if_sid>101206</if_sid>
    <match>MD5=916158753861BC3DD841DB519C420A43,SHA256=F7CA7F672CE4C98700741293FA3A417D8D31E2D06F58C3E4C91C4951670CA52D,IMPHASH=633CC7A4F1E380122F1CD317AD65D9BA</match>
    <description>AccessData FTK Imager se ha ejecutado en el sistema. Alerta detectada a través de hash</description>
 </rule>
 
 <!--DETECTA CUANDO SE EJECUTA LA HERRAMIENTA-->
 <rule id="101230" level="14">
    <if_sid>101206</if_sid>
    <field name="win.eventdata.commandLine">FTK Imager.exe</field>
    <field name="win.eventdata.originalFileName">^FTK Imager.exe$</field>
    <description>ATENCIÓN. AccessData FTK Imager se ha ejecutado en el sistema</description>
 </rule>
 
 <!--archivo creado por FTK, solo detecta el pagefile.sys generado como uno de los archivos durante el proceso de volcado.-->
 <rule id="101231" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.image">FTK Imager.exe$</field>
    <field name="win.eventdata.targetFileName">C:\\\\.+\\\\.+\\\\AppData\\\\Local\\\\Temp\\\\ad_driver.sys$</field>
    <description>ATENCIÓN. AccessData FTK Imager cargó el driver ad_driver.sys en la carpeta Temp. Ruta completa: $(win.eventdata.targetFileName)</description>
 </rule>
 
 <!--Creacion de .mem y .raw-->
    <rule id="101232" level="15">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)notepad.exe</field>
     <field name="win.eventdata.targetFilename" type="pcre2">\.mem$|\.raw$</field>
    <description>ATENCIÓN. Posible volcado de memoria en $(win.eventdata.targetFileName)</description>
 </rule>
 
 <!--Sobre las alertas generadas por FTK imager y cambios en el registro de windows-->
 <rule id="101233" level="14">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.targetObject">HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\ad_driver</field>
    <description>ATENCIÓN. Cambio en la clave del registro de Windows realizado por AccessData FTK Imager. Registro:$(win.eventdata.targetObject)</description>
 </rule>
 
 <!--Iniciar DumpIt.exe-->
 <rule id="101234" level="14">
    <if_sid>101101</if_sid>
    <match>MD5=84F0FEB07BEAE896D471F45527D781B0,SHA256=7850850434059ADB8354629E2D1102A8FCC7BE8B606EDBB4BBB22A1060BAEC26,IMPHASH=43113498B8B20F2C980E4C01B8A5839D</match>
    <description>ATENCIÓN. DumpIt.exe ha sido ejecutado en el sistema</description>
 </rule>
 
 <!--Para DumpIt.exe, tambien durante el proceso de volcado es ejecutado el driver propio del ejecutable DumpIt.sys-->
 <!--rule id 101106 Driver Loaded-->
 <rule id="101235" level="14">
    <if_sid>101106</if_sid>
    <match>MD5=4CE020C907C531F9AB9E50956F3182E9,SHA256=BF33CAEE4C0E956CA0503338F191B1907C254D99D6779FE2EE54F5A6C0F838F7,IMPHASH=508C339FFB85BE44A52F63521F29F2CC</match>
    <description>ATENCIÓN. Driver DumpIt.sys inició un proceso en el sistema.</description>
 </rule>
 
 <!--el driver DumpIt.sys es colocado por el ejecutable DumpIt.exe-->
  <rule id="101236" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.targetFileName">DumpIt.sys$</field>
    <description>ATENCIÓN. Driver DumpIt.sys ha sido colocado por $(win.eventdata.image)</description>
 </rule>
 
 <!--Driver ejecutado cuando inicia el volcado-->
 <rule id="101236" level="14">
    <if_sid>101111</if_sid>
    <field name="win.eventdata.targetFileName">DumpIt.sys$</field>
    <description>ATENCIÓN. Driver DumpIt.sys ha sido colocado por $(win.eventdata.image)</description>
 </rule>
 
 <!---->
 <rule id="101237" level="0">
    <if_sid>92032</if_sid>
    <field name="win.eventdata.currentDirectory" type="pcre2">C:\\\\Procesos\\\\MiFactura\\\\(PROD|TM_PROD)\\\\ProcesarFacturasRest</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\cmd.exe</field>
    <description>Proceso normal de ProcesarFacturasRest</description>
 </rule>
 
 
 <!--Este evento se genera cuando un ejecutable realiza lo siguiente:-->
 <!--1 - crea un proceso secundario o en este caso el ejecutable crea un servicio que se puede evidenciar en la clave del registro de Windows, en ella se ve el nombre del servicio y el cambio que realiza. Para este ejemplo el ejecutable en cuestión crea un servicio llamado "bam" con sus parametros de configuracion y además apunta a cmd.exe como su proceso principal-->
 <!--HKLM\\System\\CurrentControlSet\\Services\\bam\\State\\UserSettings\\S-1-5-21-2810472648-2250174720-1264343144-500\\\\Device\\HarddiskVolume2\\Windows\\System32\\cmd.exe-->
 <!--Básicamente esta regla detecta si un proceso esta realizando cambios en clave de registro de windows y estos cambios apuntan a cmd-->
     <!--quito esta etiqueta y excluyo directamente <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)[c-z]:\\\\Users</field>-->

 <!-- Renzo: Regla dada de baja por desuso -->
 
  <!-- <rule id="101238" level="14">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)[c-z]:\\\\Users</field>
    <field name="win.eventdata.targetObject" type="pcre2">HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\.+\\\\.+\\\\.+\\\\.+\\\\\\\\Device\\\\HarddiskVolume2\\\\Windows\\\\System32\\\\cmd.exe$</field>
    <description>ATENCIÓN. Un proceso asignó a cmd.exe como su ejecutable principal desde el registro de Windows. Imagen: $(win.eventdata.image) </description>
 </rule> -->

 <!-- Renzo: Regla original Suspicious Windows cmd shell execution, hecho el overwrite porque está en un archivo default, esta nueva versión de la regla excluye el proceso MiFactura, genera cerca de 60 mil hits diarios -->
 <rule id="92032" level="10" overwrite="yes">
    <if_sid>92031, 61603</if_sid>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">(?i)[c-z]:\\\\Procesos\\MiFactura\\.+\\</field>
    <field name="win.eventdata.parentImage" type="pcre2">(?i)cmd\.EXE</field>
    <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)\s\/C\s</field>
    <options>no_full_log</options>
    <description>$(win.eventdata.parentUser) ejecutó un shell utilizando CMD</description>
    <mitre>
      <id>T1087</id>
      <id>T1059.003</id>
    </mitre>
  </rule>
 
 
 <!-- Renzo: Solo modificada la descripción, cambiando el win.eventdata.image (ya que se repite practicamente siempre) por una más adecuada -->
 <!--regla original en 0800-sysmon_id_1, a esta regla solo le hago un cambio, level=3 a level=14 hasta exluir o intentificar los procesos normales y luego exluirlos-->
 <!--Esta regla genera una alerta cuando se utiliza el binario net.exe desde cmd (if_sid 92032 indica a cmd.exe como origen), lo que se debe tener en cuenta es el directorio de origen de dicho proceso, normalmente son pocos y tienen que ver con los procesos automáticos aparentemente en el caso de wazuh, ya que se observan varios eventos net stop Wazuh y net start Wazuh desde el directorio ossec, lo normal seria ver a este proceso desde el directorio System32 como origen y es ahi donde se tiene que tener especial atención.
 En el caso de un descubrimiento a través de un command and control, el directorio de origen de net.exe no será el directorio System32-->
  <rule id="92036" level="14" overwrite="yes">
    <if_sid>92032</if_sid>
    <field name="win.eventdata.originalFileName" type="pcre2">(?i)(SystemPropertiesAdvanced|net)\.EXE</field>
    <options>no_full_log</options>
    <description>$(win.eventdata.parentUser) invocó "net" mediante CMD y ejecutó $(win.eventdata.commandLine)</description>
    <mitre>
      <id>T1059.003</id>
      <id>T1574.001</id>
    </mitre>
  </rule>
 
 <!-- Renzo: Regla 101239 dada de baja por desuso, segun sus condiciones alerta solamente la ejecución de net con PandoraAgent -->
 
 <!--activar luego del evento-->
 <!--Siguiendo con el proceso anterior, si el binario net.exe es llamado desde otro directorio que no sean los normales como los que hasta el momento se tienen identificados como ser:-->
 <!--net stop/start Wazuh desde el directorio de Wazuh y net stop/start PandoraAgent desde System32, se generará la siguiente alerta-->
 <!-- <rule id="101239" level="14">
    <if_sid>92036</if_sid>
    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">(?i)[c-z]:\\\\Program Files (x86)\\\\ossec-agent$|C:\\\\Windows\\\\system32$</field>
    <field name="win.eventdata.commandLine">net\s+start\s+PandoraFMSAgent|net\s+stop\s+PandoraFMSAgent</field>
    <description>ATENCIÓN. $(win.eventdata.commandLine) ejecutado desde $(win.eventdata.currentDirectory) a través de cmd.exe</description>
 </rule> -->
 
 <!--Luego el evento 92039 es generado de forma predeterminada cuando se utiliza el parámetro user\s como se ve a continuación-->
 
 <!--<rule id="92039" level="3">-->
 <!--   <if_sid>92031</if_sid>-->
 <!--   <field name="win.eventdata.commandLine" type="pcre2">(?i)user\s</field>-->
 <!--   <options>no_full_log</options>-->
 <!--   <description>A net.exe account discovery command was initiated</description>-->
 <!--   <mitre>-->
 <!--     <id>T1087</id>-->
 <!--   </mitre>-->
 <!-- </rule>-->
 
  
 <!--En esta regla derivada de 92039 (A net.exe account discovery command was initiated) exluimos al directorio ossec-agent ya que éste realiza ese proceso de forma automatica como parte de su configuración-->
 <rule id="101240" level="10">
     <if_sid>92039</if_sid>
     <field name="win.eventdata.commandLine">\.+</field>
     <field name="win.eventdata.currentDirectory">C:\\\\Program Files (x86)\\\\ossec-agent</field>
     <!--<field name="win.eventdata.parentImage">C:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe$</field>-->
     <description>$(win.eventdata.commandLine) ejecutado por Ossec</description>
 </rule>
 
 <!--Seguir excluyendo eventos no relevantes-->
 <!--<rule id="101241" level="0">-->
 <!--    <if_sid>92032</if_sid>-->
 <!--    <field name="win.eventdata.currentDirectory" type="pcre2" negate="yes">C:\\\\Procesos\\\\MiFactura\\\\TM_PROD\\\\ActualizarEstadoSet</field>-->
 <!--    <description>$(win.eventdata.commandLine) ejecutado desde directorio $(win.eventdata.currentDirectory)</description>-->
 <!--</rule>-->
 
 <!--exluir este evento que lo que hace es sincronizar la zona horaria del sistema. Aproximadamente 250mil eventos por día-->
 <!--data.win.eventdata.targetObject HKLM\\System\\CurrentControlSet\\Services\\W32Time\\Config\\LastKnownGoodTime-->
 <!--Actividad legítima: El servicio W32Time es un servicio legítimo del sistema que se utiliza para sincronizar el tiempo del sistema. Si el proceso svchost.exe es legítimo y el usuario NT AUTHORITY\SERVICIO LOCAL está autorizado para modificar servicios, entonces es probable que la modificación del valor del registro sea una actividad legítima.-->
<!--Actividad maliciosa: Si el proceso svchost.exe no es legítimo o ha sido comprometido, o si el usuario NT AUTHORITY\SERVICIO LOCAL ha sido comprometido, entonces es posible que la modificación del valor del registro sea maliciosa. Un adversario podría modificar el valor del registro para manipular el tiempo del sistema, lo que podría tener varias implicaciones, como la evasión de la detección de malware o la falsificación de registros.-->
 <rule id="101242" level="0">
    <if_sid>101113</if_sid>
    <field name="data.win.eventdata.image">^C:\\\\Windows\\\\system32\\\\svchost.exe$</field>
    <field name="win.eventdata.user">^NT AUTHORITY\\SERVICIO LOCAL$</field>
    <field name="win.system.computer">^SERVERPANTALLA.grupotoyotoshi.com.py$|^SERVERBDFACTE.grupotoyotoshi.com.py$|^SERVERAP.grupotoyotoshi.com.py$|^SERVERLAB.grupotoyotoshi.com.py$|^SERVERAPFACTE.grupotoyotoshi.com.py$|^SERVERBDDEV.grupotoyotoshi.com.py$|^SERVERSL18.grupotoyotoshi.com.py$|^SERVEREXCHANGE.grupotoyotoshi.com.py$|^SERVERWSERVICES.grupotoyotoshi.com.py$|^BD-APP$|^SERVERINTRA.grupotoyotoshi.com.py$|^SERVERAPDEV.grupotoyotoshi.com.py$|^servertgc.grupotoyotoshi.com.py$|^SERVERPRT.grupotoyotoshi.com.py$|^SERVERAP18.grupotoyotoshi.com.py$|^HyperVServer5.grupotoyotoshi.com.py$|^SERVERAPWEB.grupotoyotoshi.com.py$|^SERVERAPFACTETE.grupotoyotoshi.com.py$|^SRVPAGOBANCARD.grupotoyotoshi.com.py$|^SERVERBK.grupotoyotoshi.com.py$|^HYPER-V-SERVER7$|^cdeventas3.grupotoyotoshi.com.py$|^SERVERRPA.grupotoyotoshi.com.py$|^auditoria1.grupotoyotoshi.com.py$|^Hyper-V-Server5$|^WIN-I9GUBJ09CGM.testDomain.com$|^win10$|^WindowsVM$</field>
    <description>Sincronización de zona horaria del sistema</description>
 </rule>
 
 <rule id="101243" level="3">
    <if_sid>92032</if_sid>
    <field name="win.eventdata.currentDirectory">C:\\\\Program Files\\\\pandora_agent\\\\util$</field>
    <description>Cmd command de Pandora Agent. Comportamiento Normal</description>
 </rule>
 
 <!--La regla 101201 tambien detecta creacion de tarea programada en eventos proveidos por Sysmon, en este caso id 11 File Created, al igual que en el id 102029 eventos proveidos por Microsoft-Windows-Security-Auditing se deben ir haciendo exluisiones en ambas reglas-->
 <!--Ejemplo en el caso de EventID 11 File Created -->
<!-- 
"File created:
RuleName: T1053
UtcTime: 2023-12-18 18:58:06.048
ProcessGuid: {0cb366b9-8293-6580-1900-000000005900}
ProcessId: 1240
Image: C:\Windows\system32\svchost.exe
TargetFilename: C:\Windows\System32\Tasks\CreateExplorerShellUnelevatedTask
CreationUtcTime: 2023-12-04 20:07:03.733
User: NT AUTHORITY\SYSTEM"-->
<rule id="101244" level="0">
    <if_sid>101201</if_sid>
    <field name="win.eventdata.targetFilename">^C:\\\\Windows\\\\System32\\\\Tasks\\\\CreateExplorerShellUnelevatedTask$</field>
    <description>Esta tarea se usa comúnmente por aplicaciones que necesitan acceder al Explorador de archivos sin elevar privilegios. Por ejemplo, una aplicación de limpieza de archivos podría usar esta tarea para abrir el Explorador de archivos y buscar archivos para eliminar.</description>
</rule>

<rule id="101245" level="0">
    <if_sid>92032</if_sid>
    <field name="win.eventdata.commandLine">php  procesarNotaCreditoTM.php</field>
    <description>Regla de prueba $(win.eventdata.commandLine)</description>
</rule>

<!--servicios registro de windows-->
<!--esta regla ya existe en el fichero de config de sysmon-->
<!--<rule id="101246" level="14">-->
<!--    <if_sid>101112</if_sid>-->
<!--    <field name="win.eventdata.targetObject">HKLM\\\\System\\\\CurrentControlSet\\\\Services</field>-->
<!--<description>Servicio instalado en el sistema. $(win.eventdata.targetObject) </description>-->
<!--</rule>-->
<!--modificacion de servicios evento 13 se sysmon-->
<!--<rule id="101247" level="14">-->
<!--    <if_sid>101113</if_sid>-->
<!--    <field name="win.eventdata.targetObject">HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\.+\\\\ImagePath</field>-->
<!--    <description>El servicio ha sido configurado para apuntar a la imagen</description>-->
<!--</rule>-->


	
	<!--la regla 104041 ya se utilizó-->
	<!--Prueba, regla para detección de cambio de MAC Address utilizando el evento 13 de Sysmon-->
	<!--HKLM\\System\\CurrentControlSet\\Services\\*\\ImagePath|HKLM\\System\\CurrentControlSet\\Services\\.+\\ImagePath|HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\.*\\\\ImagePath|-->
	<!--|HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\\.+\\\\ImagePath-->
	<!--HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\.+\\\\ImagePath|-->
	<!--no anda-->
	<!--HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\\.*\\\\ImagePath-->
    <rule id="104042" level="14">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2">HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\.+\\\\ImagePath</field>
        <description>Evento de Registro: ATENCION. Se ha efectuado un cambio de path de servicio</description>
    </rule>
    <rule id="104043" level="0">
        <if_sid>104042</if_sid>
        <field name="win.eventdata.details" type="pcre2">C:\\\\Windows\\\\(system32|System32)\\\\svchost.exe -k UnistackSvcGroup</field>
        <description>Evento de Registro: Evento normal de svchost.exe</description>
    </rule>
    
    <rule id="104044" level="0">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Users\\\\eservice\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python310\\\\python\.exe</field>
        <description>Evento de Registro: Evento normal de svchost.exe</description>
    </rule>
	
	<!--excluir spoolsv.exe dentro de System32-->
	 <rule id="104045" level="0">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\spoolsv\.exe</field>
        <description>Evento de Registro: Evento normal de cola de impresión de spoolsv.exe</description>
    </rule>
    
    <rule id="104048" level="14">
        <if_sid>101113</if_sid>
        <field name="win.eventdata.targetObject" type="pcre2">HKLM\\\\System\\\\CurrentControlSet\\\\Control\\\\Class\\\\{4d36e972-e325-11ce-bfc1-08002be10318}\\\\.+\\\\NetworkAddress</field>
        <description>ATENCION. Se ha cambiado el registro de las interfaces de red. Posible Spoofing</description>
    </rule>
    
    
RuleName: -
EventType: DeleteValue
UtcTime: 2024-01-09 19:48:07.887
ProcessGuid: {6B059283-816D-6576-1B00-00000000DD01}
ProcessId: 2752
Image: C:\Windows\System32\spoolsv.exe
TargetObject: HKLM\System\CurrentControlSet\Enum\SWD\PRINTENUM\{F2D2866F-6957-40AD-B980-4DD5FF3EA765}\FriendlyName
User: NT AUTHORITY\SYSTEM"

<!--Volver a investigar mejor estos eventos en el registro de Windows-->
	 <rule id="104046" level="0">
        <if_sid>101112</if_sid>
        <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\spoolsv\.exe</field>
        <description>Evento de Registro: Evento normal de cola de impresión de spoolsv.exe</description>
    </rule>

<!--este evento de registro genera aprox. 400mil hits, en sysmon la regla apunta al registro, en Wazuh se excluye que los cambios en el registro se generan mediante el spoolsv.exe(impresión)-->
<rule id="104047" level="0">
    <if_sid>101113</if_sid>
    <field name="win.eventdata.image">^C:\\\\Windows\\\\System32\\\\spoolsv\.exe$</field>
    <field name="win.eventdata.targetObject">HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Ports</field>
    <field name="win.eventdata.user">^NT AUTHORITY\\\\SYSTEM$</field>
    <description>Cambios en el registro de windows de soolsv.exe</description>
</rule>
	
FILE STREAM EVENTO 15 DE SYSMON, DETECTA ARCHIVOS CREADOS O DESCARGADOS
	 <!--<rule id="61617" level="0">-->
  <!--  <if_sid>61600</if_sid>-->
  <!--  <field name="win.system.eventID">^15$</field>-->
  <!--  <description>Sysmon - Event 15: $(win.eventdata.targetFilename) FileCreateStreamHash by process $(win.eventdata.image)</description>-->
  <!--  <options>no_full_log</options>-->
  <!--  <group>sysmon_event_15,</group>-->
  <!--</rule>-->
  <!--.exe|.bat|.vbs|.dll|.cmd|.ps1|.js|.jse|.msi|.com|.jar|.pif|.scr|.jpeg|.zip|.xml-->
  Ejemplo de descarga del ejecutable de chrome a través de edge:
  Evento 15 de Sysmon
  "File stream created:
RuleName: -
UtcTime: 2024-01-13 21:42:20.117
ProcessGuid: {0cb366b9-03b8-65a3-7d01-000000005000}
ProcessId: 1316
Image: C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe
TargetFilename: C:\Users\Administrator\Downloads\ChromeSetup.exe
CreationUtcTime: 2024-01-13 21:42:15.491
Hash: MD5=E07982EB1B9BE08E57BBD22F4A157837,SHA256=CBBFA3225573C69E589E992B36BDBE4853D1FEB1A5E7664617C6CED97B1BDE7C,IMPHASH=7E2F200A9ECAA7EE1D0F7298F297D727
Contents: -

Otro evento a tener en cuenta en la descarga de un archivo hace referencia al targetFilename a la siguiente ruta
C:\\Users\\sorquiola\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Download Service\\Files\\11f08f2a-908d-4ede-8f53-68c1832c7736
Esta ruta es donde chrome crea archivos temporales durante una descarga, tambien chrome utiliza esta carpeta para las actualizaciones de extensiones o del propio navegador. El evento completo es el siguiente:

File stream created:
RuleName: -
UtcTime: 2024-01-13 11:48:38.946
ProcessGuid: {0eaac0f2-7896-65a2-cf55-000000002400}
ProcessId: 25312
Image: C:\Program Files\Google\Chrome\Application\chrome.exe
TargetFilename: C:\Users\sorquiola\AppData\Local\Google\Chrome\User Data\Default\Download Service\Files\11f08f2a-908d-4ede-8f53-68c1832c7736
CreationUtcTime: 2024-01-13 11:48:38.477
Hash: SHA1=FE4FE1E9F6F7BB2873B93250A102F2D8B1D0EBA6,MD5=54E2E685382EB117666B3F58BC601FEF,SHA256=4E2FB8FC8E14FA25DDC9E22A4670C15ED86E1151CE5D0CAA346A80B69C2CE699,IMPHASH=00000000000000000000000000000000
Contents: -

Para entender mejor el funcionamiento de la regla original del arvhivo sysmonconfig.xml:  File stream created del evento 15 de Sysmon, la regla tiene en cuenta entre otras cosas los siguientes directorios
OBS.si el archivo se descarga por ejemplo en el directorio Document, la regla no lo reconoce a pesar de que en teoria todo lo que se cree dentro de Users lo detecta, por ende agregué al fichero sysmonconfig.xml otro tarteFilename Usuarios y recién ahí se detectaba una descarga en cualquier directorio dentro de users
<!--<TargetFilename name="Archivos detectados en Downloads" condition="contains">Downloads</TargetFilename>-->
<!--        <TargetFilename condition="contains">AppData</TargetFilename>-->
<!--        <TargetFilename condition="contains">Temp</TargetFilename>-->
<!--        <TargetFilename condition="contains">ProgramData</TargetFilename>-->
<!--        <TargetFilename condition="contains">Users</TargetFilename>-->
Lo que se contenga dentro de ellos es lo que se debe indicar en esta regla, recordar que la regla original es 61617 que hace referencia al event ID 15 de Sysmon pero dicha regla está en 0 y recién aquí se activa

Se declara a continuación que archivos con las siguientes extensiones serán alertados, evitando así eventos de temporales de chrome
comentar mientras se hacen pruebas
	<!--<rule id="101248" level="14">-->
	<!--    <if_sid>61617</if_sid>-->
	<!--    <field name="win.eventdata.image">\.+</field>-->
	<!--    <field name="win.eventdata.targetFilename">\.exe|\.bat|\.vbs|\.dll|\.cmd|\.ps1|\.js|\.jse|\.msi|\.com|\.jar|\.pif|\.scr|\.jpeg|\.zip|\.xml|\.jpg|\.txt|\.py</field>-->
	<!--    <options>no_full_log</options>-->
	<!--    <description>Archivo descargado por $(win.eventdata.user). Ubicación: $(win.eventdata.targetFileName)</description>-->
	<!--</rule>-->
	
	 <!--Esta regla detecta la descarga o la creación de un archivo en el directorio Downloads-->
  <!--<rule id="101208" level="14">-->
  <!--  <if_sid>101111</if_sid>-->
  <!--  <field name="win.eventdata.ruleName">^Downloads$</field>-->
  <!--  <field name="win.eventdata.image" type="pcre2" negate="yes">C:\\\\Windows\\\\Explorer.EXE</field>-->
  <!--  <description>Archivo descargado o creado en el directorio downloads.  $(win.eventdata.targetFileName)</description>-->
  <!--</rule>-->
	
	<!--archivos adjuntados en outlook (aparentemente, seguir haciendo pruebas con este evento)-->
	<rule id="101249" level="14">
	    <if_sid>101248</if_sid>
	    <field name="win.eventdata.image">OUTLOOK.EXE$</field>
	    <field name="win.eventdata.targetFilename" type="pcre2">(?i)C:\\\\Users\\\\.+\\\\AppData\\\\Local\\\\Temp\\\\VPMECTMP</field>
	    <description>$(win.eventdata.targetFilename) adjuntado en OUTLOOK</description>
	</rule>
	
		<!--descargas a través de whatsapp-->
	<rule id="101250" level="14">
	    <if_sid>101248</if_sid>
	    <field name="win.eventdata.image">Downloads\\\\WhatsApp Image</field>
	    <description>$(win.eventdata.targetFilename) descargado desde WhatsApp</description>
	</rule>
	
	
	<!--la regla 101111 de file create en su apartado de regla  <TargetFilename name="Archivos descargados o colocados en la Directorio Downloads" condition="contains">\Downloads\</TargetFilename>, deteta todos los archivos descargados o creados en ese directorio-->
	<rule id="101251" level="14">
	    <if_sid>101111</if_sid>
	    <field name="win.eventdata.targetFilename" type="pcre2">(?i)C:\\\\Users\\\\.+\\\\Downloads</field>
	    <field name="win.eventdata.targetFilename" type="pcre2" negate="yes">.tmp$</field>
	    <!--<field name="win.eventdata.ruleName">Archivo descargado en la carpeta Downloads</field>-->
	    <description>Archivo descargado o creado en el directorio Downloads</description>
	</rule>
	
	<rule id="101252" level="15">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\vssadmin.exe</field>
    <field name="win.eventdata.commandLine">Create|Shadow|List|vssadmin</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\cmd.exe|C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
    <description>ATENCION. Se ha invocado a vssadmin.exe mediante consola. Posible extraccion de credenciales. $(win.eventdata.commandLine)</description>
  </rule>
  
  <rule id="101253" level="15">
    <if_sid>101101</if_sid>
    <field name="win.eventdata.image">C:\\\\Windows\\\\System32\\\\cscript.exe</field>
    <field name="win.eventdata.commandLine">Create|Shadow|List|vssadmin</field>
    <field name="win.eventdata.parentImage">C:\\\\Windows\\\\System32\\\\cmd.exe|C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe</field>
    <description>ATENCION. Se ha invocado a vssadmin.exe mediante la ejecucion de un script. Posible extraccion de credenciales. $(win.eventdata.commandLine)</description>
  </rule>
  <!--101254 ya se usa-->
  <!--101255 ya esta en uso, ejecucion sospechosa de proceso en powershell-->
</group>
 
 
 <!--Comentario de prueba-->