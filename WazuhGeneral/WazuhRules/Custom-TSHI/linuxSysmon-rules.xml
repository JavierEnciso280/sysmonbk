<!-- Modify it at your will. -->
<group name="linux,sysmon,">
    <rule id="200150" level="0">
        <decoded_as>sysmon-linux</decoded_as>
        <field name="system.eventId">\.+</field>
        <group>sysmon_event1</group>
        <description>Sysmon For Linux Event</description>
        <mitre>
         <id>T1204</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
<!--EventID = 1-->
    <rule id="200151" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^1$</field>
        <field name="eventdata.currentDirectory" type="pcre2" negate="yes">^/var/ossec$</field>
        <description>Sysmon - Event 1: Creación de proceso $(eventdata.image)</description>
        <group>sysmon_event1</group>
        <mitre>
         <id>T1204</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
<!--EventID = 3-->
    <rule id="200152" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^3$</field>
        <description>Sysmon - Event 3: Network connection by $(eventdata.image)</description>
        <group>sysmon_event3</group>
        <mitre>
         <id>T1043</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
<!--EventID = 5-->
<!--
    <rule id="200153" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^5$</field>
        <description>Sysmon - Event 5: Proceso terminado $(eventdata.image)</description>
        <group>sysmon_event5</group>
        <mitre>
         <id>T1204</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    -->
<!--EventID = 9-->
<!--
    <rule id="200154" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^9$</field>
        <description>Sysmon - Event 9: Acceso sin procesar leído por $(eventdata.image)</description>
        <group>sysmon_event9</group>
        <mitre>
         <id>T1204</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    -->
<!--EventID = 11-->
    <rule id="200155" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^11$</field>
        <description>Sysmon - Event 11: Archivo creado por $(eventdata.image)</description>
	      <group>sysmon_event_11</group>
        <mitre>
         <id>T1044</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
<!--EventID = 16-->
    <rule id="200156" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^16$</field>
        <description>Sysmon - Event 16: El estado de configuración de Sysmon cambió $(Event.EventData.Data.Configuration)</description>
        <group>sysmon_event_16</group>
        <mitre>
         <id>T1562</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
<!--EventID = 23-->
    <rule id="200157" level="3">
        <if_sid>200150</if_sid>
        <field name="system.eventId">^23$</field>
        <description>Sysmon - Event 23: Archivo borrado (A file delete was detected) por $(eventdata.image)</description>
        <group>sysmon_event_23</group>
        <mitre>
         <id>T1107</id>
         <id>T1485</id>
        </mitre>
        <options>no_full_log</options>
    </rule>

<!--*******************************************************************  SEGUNDO BLOQUE *****************************************************************************-->
<!--INICIA AQUI EL SEGUNDO BLOQUE DE REGLAS BASADAS EN LA PRIMERA PARTE (DESDE EL ID 200150 HASTA 200157), EN EL SEGUNDO BLOQUE SE IRÁN SUBCATEGORIZANDO ALGUNOS EVENTOS COMO TAMBIÉN LA EXLUSIÓN 
SI CON EL TIEMPO SE VAN AGREGANDO CAPACIDADES DE DETECCIÓN EXTRAS PARA SYSMON EN LINUX, AGREGARLAS ARRIBA EN EL PRIMER BLOQUE-->
<!--PARA CADA ID DE REGLA DE SYSMON SE VAN A RESERVAR 199 ID´s POR CUESTIONES DE MODULARIDAD.-->

    <!--**************************************************************** EVENT ID 1-RULE ID 200151 = Creación de procesos ************************************************************************-->
    
    <!--<rule id="200100" rule="3">-->
    <!--    <if_sid>200151</if_sid>-->
    <!--    <field name=""></field>-->
    <!--    <description></description>-->
    <!--</rule>-->
    
    
    <!--**************************************************************** Fin EVENT ID 1 = Creación de procesos ***********************************************************************************-->
    
    
        
    RESERVADO PARA EVENTO 2, 200300 A 200499
    <rule id="200300" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/passwd</field>
        <description>Acceso al archivo passwd</description>
    </rule>
    <rule id="200301" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/shadow</field>
        <description>Acceso al archivo shadow</description>
    </rule>
    <rule id="200302" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">~/.bash_history | ~/.zsh_history|/root/.bash_history|/etc/bash.bashrc|/root/.zsh_history</field>
        <description>Acceso al archivo history</description>
    </rule>
    <rule id="200303" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/crontab</field>
        <description>Acceso al archivo crontab</description>
    </rule>
    <rule id="200304" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">~/.bashrc</field>
        <description>Acceso al archivo bashrc</description>
    </rule>
    <rule id="200305" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/rc.local</field>
        <description>Acceso al archivo rc.local</description>
    </rule>
    <rule id="200306" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/ssh/ssh_config</field>
        <description>Acceso al archivo ssh_config</description>
    </rule>
    <rule id="200307" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">/etc/sudoers</field>
        <description>Acceso al archivo sudoers</description>
    </rule>
    <rule id="200308" level="15">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">\.+</field>
        <field name="eventdata.image">^/usr/bin/mount$</field>
        <description>Binario mount ha sido ejecutado</description>
    </rule>
    
    <!-- Barra de notificacion que sale al iniciar el equipo -->
    <rule id="200309" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/lib/update-notifier/ubuntu-advantage-notification$|^/usr/lib/update-notifier/livepatch-notification$</field>
        <description>Barra de notificacion de actualizaciones</description>
    </rule>
    <!-- xdg-user-dirs es un comando utilizado en sistemas Linux que implementan el estándar XDG (FreeDesktop.org) para gestionar los directorios del usuario. -->
    <rule id="200310" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^xdg-user-dirs</field>
        <description>Ejecución del comando xdg-user-dirs para la gestión de directorios del usuario</description>
    </rule>
    <!-- D-Bus es un sistema de comunicación entre procesos que permite que las aplicaciones se comuniquen entre sí y compartan datos en el sistema. -->
    <rule id="200311" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/dbus-daemon</field>
        <description>Uso del demonio Dbus de comunicacion entre aplicaciones</description>
    </rule>
    <!-- gpg-connect-agent es una herramienta que proporciona una interfaz para interactuar con el agente de GnuPG (gpg-agent) y realizar diversas operaciones relacionadas con la gestión de claves y la criptografía. -->
    <rule id="200312" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^gpg-connect-agent</field>
        <description>Uso de interfaz de comunicacion con el agente GnuPG</description>
    </rule>
    <!-- readlink -f se utiliza para seguir un enlace simbólico y mostrar la ruta del archivo o directorio -->
    <rule id="200313" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^readlink</field>
        <description>Uso de interfaz de comunicacion con el agente GnuPG</description>
    </rule>
    <!-- gdbus llama a un método en el sistema de bus de mensajes D-Bus. -->
    <rule id="200314" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/gdbus call</field>
        <description>Llamada a un metodo del D-Bus</description>
    </rule>
    <!-- el programa gpgv se utiliza para verificar firmas de archivos. -->
    <rule id="200315" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^gpgv</field>
        <description>El usuario $(eventdata.parentUser) invocó la verificacion de firma de archivos</description>
    </rule>
    <!-- Invoca el daemon del Bus de Entrada (Input Bus) (IBus), que es un componente fundamental para la entrada de texto. -->
    <rule id="200316" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/ibus-daemon</field>
        <description>Invocación de demonio del bus de entrada por el usuario: $(eventdata.parentUser)</description>
    </rule>
    <!-- Invocación de herramienta para administrar los paquetes instalados en el sistema  -->
    <rule id="200317" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^dpkg</field>
        <description>Uso de la herramienta DPKG por el usuario: $(eventdata.parentUser)</description>
    </rule>
    <!-- env puede utilizarse para ejecutar otro comando con un entorno de ejecución específico, permitiendo establecer variables de entorno adicionales o modificar las existentes antes de la ejecución del comando. -->
    <rule id="200318" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^env</field>
        <description>Uso del comando env por el usuario: $(eventdata.parentUser)</description>
    </rule>
    <!-- se utiliza para habilitar la funcionalidad de arrastrar y soltar y copiar y pegar entre una máquina virtual y el sistema operativo host.  -->
    <rule id="200319" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/vmware-user-suid-wrapper</field>
        <description>Activacion de la funcionalidad de arrastrar y soltar en una VM por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  es una herramienta poderosa para administrar instantáneas, que son paquetes de software ligeros y autosuficientes que permiten a los usuarios instalar y administrar aplicaciones de manera eficiente en sistemas basados en snap. -->
    <rule id="200320" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/snap|^snap</field>
        <description>Uso del comando snap por el usuario: $(eventdata.user)</description>
    </rule>
    <!-- el comando invoca el servidor XWayland con una serie de opciones de configuración específicas para controlar su comportamiento -->
    <rule id="200321" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/Xwayland</field>
        <description>Invocación del servidor XWayland por el usuario: $(eventdata.user)</description>
    </rule>
    <!-- la herramienta xprop es usada establecer propiedades en la raíz de la ventana en el sistema X Window. Los cambios en las propiedades de la ventana raíz pueden tener un impacto significativo en la apariencia y el comportamiento del entorno de escritorio, y podrían indicar actividades relacionadas con la configuración o personalización del sistema -->
    <rule id="200322" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^xprop </field>
        <description>Cambio de propiedades en la raíz de la ventana del sistema X Window por el usuario: $(eventdata.parentUser)</description>
    </rule>
    <!--  la herramienta busctl es usada para realizar una llamada a un método en el bus D-Bus del usuario -->
    <rule id="200323" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^busctl</field>
        <description>Llamada a un método en el bus D-Bus del usuario: $(eventdata.parentUser)</description>
    </rule>
    <!--  uso de python3 -->
    <rule id="200324" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/python3</field>
        <description>Ejecución de proceso Python3 por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  El comando getent es una herramienta versátil que se utiliza para consultar y mostrar información de diferentes bases de datos de información del sistema -->
    <rule id="200325" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^getent</field>
        <description>Ejecución del comando getent por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  Es una utilidad que se utiliza para comprobar si el sistema actual está ejecutándose dentro de un entorno de chroot  -->
    <rule id="200326" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/ischroot</field>
        <description>Comprobación de entorno de chroot por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  Uso de comando apt en el sistema  -->
    <rule id="200327" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^apt</field>
        <description>Uso del comando APT por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  Detección de desmontaje en el sistema  -->
    <rule id="200328" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^fusermount3 -u</field>
        <description>Desmontaje de sistema de archivos</description>
    </rule>
    <!--  Detección de montaje en el sistema  -->
    <rule id="200333" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^fusermount3 -o|^fusermount3 -t</field>
        <description>Montaje de sistema de archivos</description>
    </rule>
    <!--  Es un ejecutable que se encarga de la gestión de directorios temporales para las sesiones de usuario dentro del sistema de inicio systemd  -->
    <rule id="200329" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/lib/systemd/systemd-user-runtime-dir</field>
        <description>Detección de ejecutable que se encarga de la gestión de directorios temporales</description>
    </rule>
    <!--  Uso de comando systemctl  -->
    <rule id="200330" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^systemctl</field>
        <description>Uso de comando SYSTEMCTL por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  Creacion de enlace simbolico entre archivos o directorios en sistemas  -->
    <rule id="200331" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^ln</field>
        <description>Creación de enlace simbolico por el usuario: $(eventdata.user)</description>
    </rule>
    <!--  Herramienta de línea de comandos para interactuar con PulseAudio -->
    <rule id="200332" level="3">
        <if_sid>200151</if_sid>
        <field name="eventdata.commandLine">^/usr/bin/pactl</field>
        <description>Interacción de PulseAudio por el usuario: $(eventdata.user)</description>
    </rule>
   
    <!--RESERVADO PARA EVENTO 2-->
    
    <!--**************************************************************** EVENT ID 3-RULE ID 200152 = Network connection ************************************************************************-->
    <!--Descartar si la imagen es = /var/ossec/bin/wazuh-agentd or Image = /usr/sbin/zabbix_agentd-->
    <rule id="200500" level="1">
        <if_sid>200152</if_sid>
        <field name="eventdata.image">wazuh-agentd$</field>
        <description>Sysmon - Event 3: Network connection by $(eventdata.image)</description>
        <group>sysmon_event3</group>
        <mitre>
         <id>T1107</id>
         <id>T1485</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    
    <!--no es lo mismo un inicio de sesion por ssh que un evento de network connection-->
   <rule id="200501" level="10">
        <if_sid>200152</if_sid>
        <field name="eventdata.image">^/usr/sbin/sshd$</field>
        <description>Actividad de red desde $(eventdata.sourceIp) al puerto $(eventdata.destinationPort)</description>
    </rule>
    
  apartado, nmap
  La regla que detecta este comportamiento es la de creación de proceso a través de la llamada al binario /usr/sbin/sshd
  comando ejecutado apuntando al equipo que genera estos eventos: nmap -sV -sC -O -v ip
  10 conexiones en 2 segundos aproximandamente
  <!--<rule id="200502" level="14" frequency="20" timeframe="10">-->
  <!--  <if_matched_sid>200204</if_matched_sid>-->
  <!--  <same_field>eventdata.sourceIp</same_field>-->
  <!--  <description>Posible escaneo de puertos. IP de origen: $(eventdata.sourceIp)</description>-->
  <!--</rule>-->
    
    <!--****************************************************************** EVENT ID 11-RULE ID 20155 = ARCHIVO CREADO ***************************************************************************-->
    
    <!-- Descartar si la imagen es = /var/ossec/bin/wazuh-agentd-->
    <rule id="200700" level="1">
        <if_sid>200155</if_sid>
        <field name="eventdata.image">wazuh-agentd$</field>
        <description>Sysmon - Event 11: Archivo creado por $(eventdata.image)</description>
        <group>sysmon_event_11</group>
        <mitre>
         <id>T1107</id>
         <id>T1485</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    
    <!--******************************************************************** EVENT ID 16-RULE ID 200156 = ESTADO DE CONFIGURACIÓN CAMBIÓ *************************************************************-->
    
    <!--EventID = 16-->
    <rule id="200900" level="3">
        <if_sid>200156</if_sid>
        <field name="system.eventId">^16$</field>
        <description>Sysmon - Event 16: El estado de configuración de Sysmon cambió $(Event.EventData.Data.Configuration)</description>
        <group>sysmon_event_16</group>
        <mitre>
         <id>T1562</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    
    <!--******************************************************************** FIN EVENT ID 16 = ESTADO DE CONFIGURACIÓN CAMBIÓ **************************************************************-->
    
    
    
    <!--******************************************************************** EVENT ID 23-RULE-ID 200157 = ARCHIVO FUE BORRADO  **************************************************************-->
<!--EventID = 23. Descartar los eventos si la imagen es = /var/ossec/bin/wazuh-agentd-->
    <rule id="201000" level="1">
        <if_sid>200157</if_sid>
        <field name="eventdata.image">wazuh-agentd$</field>
        <description>Sysmon - Event 23: Archivo borrado (A file delete was detected) por $(eventdata.image)</description>
        <group>sysmon_event_23</group>
        <mitre>
         <id>T1107</id>
         <id>T1485</id>
        </mitre>
        <options>no_full_log</options>
    </rule>
    

  
 


</group>
