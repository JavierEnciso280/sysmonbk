
<!--
  -  Web access rules
  -  Author: Daniel Cid.
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015, Wazuh Inc.
  -  Copyright (C) 2009 Trend Micro Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
  -  Reglas personalizadas desde 104000 en adelante
-->

<group name="web,accesslog,">
  <rule id="31100" level="0">
    <category>web-log</category>
    <description>Access log messages grouped.</description>
  </rule>

  <rule id="31108" level="0">
    <if_sid>31100</if_sid>
    <id>^2|^3</id>
    <compiled_rule>is_simple_http_request</compiled_rule>
    <description>Ignored URLs (simple queries).</description>
  </rule>
  
  <!--Codigos de estado 400 ante una solicitud-->
  <!--Un cliente web ubicado en la dirección IP 192.168.100.22 realizó una solicitud GET a la URL /dvwa. en el servidor web pero el servidor no encuentra el recurso-->
  <!--Se produce un status code 404 (error), la regla asume que el codigo es error porque el id está especificado que debe comenzar con 4-->
  <rule id="31101" level="5" overwrite="yes">
    <if_sid>31100</if_sid>
    <id>^4</id>
    <description>WEB. Código de error del grupo 400.</description>
    <group>attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31102" level="0">
    <if_sid>31101</if_sid>
    <url>.jpg$|.gif$|favicon.ico$|.png$|robots.txt$|.css$|.js$|.jpeg$</url>
    <compiled_rule>is_simple_http_request</compiled_rule>
    <description>Ignored extensions on 400 error codes.</description>
  </rule>

<!--/////////////////////////////////////////regla sobreescrita//////////////////////////////////////-->
  <rule id="31103" level="15" overwrite="yes">
    <if_sid>31100,31108</if_sid>
    <url>=select%20|select+|insert%20|%20from%20|%20where%20|union%20|</url>
    <url>union+|where+|null,null|xp_cmdshell</url>
    <description>ATENCIÓN. Intento de SQL Injection.</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,sql_injection,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31104" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <!-- Attempt to do directory transversal, simple sql injections,
      -  or access to the etc or bin directory (unix). -->
    <url>%027|%00|%01|%7f|%2E%2E|%0A|%0D|../..|..\..|echo;|</url>
    <url>cmd.exe|root.exe|_mem_bin|msadc|/winnt/|/boot.ini|</url>
    <url>/x90/|default.ida|/sumthin|nsiislog.dll|chmod%|wget%|cd%20|</url>
    <url>exec%20|../..//|%5C../%5C|././././|2e%2e%5c%2e|\x5C\x5C</url>
    <description>ATENCIÓN. Ataque web común.</description>
    <mitre>
      <id>T1055</id>
      <id>T1083</id>
      <id>T1190</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31105" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <url>%3Cscript|%3C%2Fscript|script>|script%3E|SRC=javascript|IMG%20|</url>
    <url>%20ONLOAD=|INPUT%20|iframe%20</url>
    <description>ATENCIÓN. Intento de XSS (Cross Site Scripting) desde la IP: $(srcip)</description>
    <mitre>
      <id>T1059.007</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.7,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31106" level="15" overwrite="yes">
    <if_sid>31103, 31104, 31105</if_sid>
    <id>^200</id>
    <description>ATENCIÓN. Ataque WEB recibió el código 200 (Success).</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31110" level="6">
    <if_sid>31100</if_sid>
    <url>?-d|?-s|?-a|?-b|?-w</url>
    <description>PHP CGI-bin vulnerability attempt.</description>
    <mitre>
      <id>T1210</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31109" level="6">
    <if_sid>31100</if_sid>
    <url>+as+varchar</url>
    <regex>%2Bchar\(\d+\)%2Bchar\(\d+\)%2Bchar\(\d+\)%2Bchar\(\d+\)%2Bchar\(\d+\)%2Bchar\(\d+\)</regex>
    <description>ATENCION. Intento de MSSQL Injection (/ur.php, urchin.js)</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>


  <!-- If your site have a search engine, you may need to ignore
    - it in here.
    -->
  <rule id="31107" level="0">
    <if_sid>31103, 31104, 31105</if_sid>
    <url>^/search.php?search=|^/index.php?searchword=</url>
    <description>Ignored URLs for the web attacks</description>
  </rule>

  <rule id="31115" level="13" maxsize="7900">
    <if_sid>31100</if_sid>
    <description>URL too long. Higher than allowed on most </description>
    <description>browsers. Possible attack.</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>invalid_access,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.8,pci_dss_10.2.4,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_SA.11,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>


  <!-- 500 error codes, server error
    - http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html
    -->
  <rule id="31120" level="5">
    <if_sid>31100</if_sid>
    <id>^50</id>
    <description>Web server 500 error code (server error).</description>
  </rule>

  <rule id="31121" level="4">
    <if_sid>31120</if_sid>
    <id>^501</id>
    <description>Web server 501 error code (Not Implemented).</description>
  </rule>

  <rule id="31122" level="5">
    <if_sid>31120</if_sid>
    <id>^500</id>
    <description>Web server 500 error code (Internal Error).</description>
    <group>system_error,</group>
  </rule>

  <rule id="31123" level="4">
    <if_sid>31120</if_sid>
    <id>^503</id>
    <description>Web server 503 error code (Service unavailable).</description>
  </rule>


  <!-- Rules to ignore crawlers -->
  <rule id="31140" level="0">
    <if_sid>31101</if_sid>
    <compiled_rule>is_valid_crawler</compiled_rule>
    <description>Ignoring google/msn/yahoo bots.</description>
  </rule>

  <!-- Ignoring nginx 499's -->
  <rule id="31141" level="0">
    <if_sid>31101</if_sid>
    <id>^499</id>
    <description>Ignored 499's on nginx.</description>
  </rule>


  <rule id="31151" level="10" frequency="14" timeframe="90">
    <if_matched_sid>31101</if_matched_sid>
    <same_source_ip />
    <description>ATENCIÓN. Multiples errores del grupo 400 en poco tiempo desde la misma IP. Posible persistencia </description>
    <mitre>
      <id>T1595.002</id>
    </mitre>
    <group>web_scan,recon,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
<!--//////////////Agregar una segunda alerta para detectar si la ip que está realizando la solicitud es la misma pero con una frecuencia mucho mas alta y en menor rango de tiempo-->
  <rule id="104000" level="15" frequency="50" timeframe="1">
    <if_matched_sid>31101</if_matched_sid>
    <same_source_ip />
    <description>ATENCIÓN. Multiple web server 400 error codes. 50 requests from ip $(srcip) in less that 1 minute</description>
    <mitre>
      <id>T1595.002</id>
    </mitre>
     <group>web_scan,recon,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31152" level="15" frequency="8" timeframe="120" overwrite="yes">
    <if_matched_sid>31103</if_matched_sid>
    <same_source_ip />
    <description>ATENCIÓN. Multiples intentos de SQL Injection desde la misma IP </description>
    <mitre>
      <id>T1055</id>
    </mitre>
    <group>attack,sql_injection,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31153" level="15" frequency="10" timeframe="120" overwrite="yes">
    <if_matched_sid>31104</if_matched_sid>
    <same_source_ip />
    <description>ATENCIÓN. Multiples intentos de Ataques WEB Comunes desde la misma IP.</description>
    <mitre>
      <id>T1055</id>
      <id>T1083</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31154" level="15" frequency="10" timeframe="120" overwrite="yes">
    <if_matched_sid>31105</if_matched_sid>
    <same_source_ip />
    <description>ATENCIÓN. Multiples intentos de XSS (Cross Site Scripting) desde la misma IP </description>
    <mitre>
      <id>T1059</id>
    </mitre>
    <group>attack,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.7,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31161" level="10" frequency="14" timeframe="120">
    <if_matched_sid>31121</if_matched_sid>
    <same_source_ip />
    <description>Multiple web server 501 error code (Not Implemented).</description>
    <mitre>
      <id>T1595.002</id>
    </mitre>
    <group>web_scan,recon,pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31162" level="10" frequency="14" timeframe="120">
    <if_matched_sid>31122</if_matched_sid>
    <same_source_ip />
    <description>Multiple web server 500 error code (Internal Error).</description>
    <group>system_error,pci_dss_6.5,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_SA.11,nist_800_53_AU.6,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31163" level="10" frequency="15" timeframe="120">
    <if_matched_sid>31123</if_matched_sid>
    <same_source_ip />
    <description>Multiple web server 503 error code (Service unavailable).</description>
    <mitre>
      <id>T1498</id>
    </mitre>
    <group>web_scan,recon,pci_dss_6.5,pci_dss_11.4,pci_dss_10.6.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_SA.11,nist_800_53_SI.4,nist_800_53_AU.6,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31164" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <url>=%27|select%2B|insert%2B|%2Bfrom%2B|%2Bwhere%2B|%2Bunion%2B</url>
    <description>ATENCIÓN. Intento de SQL Injection.</description>
    <mitre>
      <id>T1055</id>
      <id>T1190</id>
    </mitre>
    <group>attack,sqlinjection,attack,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31165" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <url>%EF%BC%87|%EF%BC%87|%EF%BC%87|%2531|%u0053%u0045</url>
    <description>ATENCIÓN. Intento de SQL Injection.</description>
    <mitre>
      <id>T1055</id>
      <id>T1190</id>
    </mitre>
    <group>attack,sqlinjection,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

<!--
    Shellshock detected
    Pattern: "(){:;};" (with spaces)
    Decoder: web-accesslog_decoders.xml

    Examples:
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 404 292 "-" "() { :;};/usr/bin/perl ..."
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { :;};/usr/bin/perl ..."
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { foo:; };/usr/bin/perl ..."
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { ignored; };/usr/bin/perl ..."
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { gry; };/usr/bin/perl ..."

    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { _; } >_[$($())] { /usr/bin/perl ... }"
    192.168.2.100 - - [02/Nov/2015:01:35:55 +0100] "GET /cgi-bin/test.sh HTTP/1.1" 200 292 "-" "() { _; foo; } >_[$($())] { /usr/bin/perl ... }"
    -->

  <!--
    Shellshock attempt
    Code: 4xx, 5xx
  -->
  <rule id="31166" level="15" overwrite="yes">
    <if_sid>31101, 31120</if_sid>
    <regex>"\(\)\s*{\s*\w*:;\s*}\s*;|"\(\)\s*{\s*\w*;\s*}\s*;</regex>
    <description>Shellshock attack attempt</description>
    <mitre>
      <id>T1068</id>
      <id>T1190</id>
    </mitre>
    <info type="cve">CVE-2014-6271</info>
    <info type="link">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271</info>
    <group>attack,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31167" level="15" overwrite="yes">
    <if_sid>31101, 31120</if_sid>
    <regex>"\(\)\s*{\s*_;\.*}\s*>_[\$\(\$\(\)\)]\s*{</regex>
    <description>Shellshock attack attempt</description>
    <mitre>
      <id>T1068</id>
      <id>T1190</id>
    </mitre>
    <info type="cve">CVE-2014-6278</info>
    <info type="link">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6278</info>
    <group>attack,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!--
    Shellshock detected
    Code: 2xx, 3xx
  -->
  <rule id="31168" level="15">
    <if_sid>31108</if_sid>
    <regex>"\(\)\s*{\s*\w*:;\s*}\s*;|"\(\)\s*{\s*\w*;\s*}\s*;</regex>
    <description>Shellshock attack detected</description>
    <mitre>
      <id>T1068</id>
      <id>T1190</id>
    </mitre>
    <info type="cve">CVE-2014-6271</info>
    <info type="link">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271</info>
    <group>attack,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31169" level="15">
    <if_sid>31108</if_sid>
    <regex>"\(\)\s*{\s*_;\.*}\s*>_[\$\(\$\(\)\)]\s*{</regex>
    <description>Shellshock attack detected</description>
    <mitre>
      <id>T1068</id>
      <id>T1190</id>
    </mitre>
    <info type="cve">CVE-2014-6278</info>
    <info type="link">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6278</info>
    <group>attack,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="31170" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <url>%2csleep|sysdate()|nslookup%20dns.sqli</url>
    <description>ATENCIÓN. Intento de SQL Injection.</description>
    <group>attack,sqlinjection,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,</group>
  </rule>

  <rule id="31171" level="15" overwrite="yes">
   <if_sid>31100</if_sid>
   <url>select%20|insert%20</url>
   <description>ATENCIÓN. Intento de SQL Injection.</description>
   <group>attack,sqlinjection,pci_dss_6.5,pci_dss_11.4,pci_dss_6.5.1,gdpr_IV_35.7.d,</group>
  </rule>
  
  
  <!--///////////////////////////////////regla original en 0270-web-appssec-->
   <!-- Suspicious URL's access
    -->
    <!--.swp$: Extensiones de archivos de guardado automático de editores de texto, como Vim o Emacs. Estos archivos pueden contener datos confidenciales, como contraseñas o datos de tarjetas de crédito.-->
    <!--.bak$: Extensiones de archivos de copia de seguridad. Estos archivos también pueden contener datos confidenciales.-->
    <!--/.htaccess: Archivo de configuración de Apache que puede utilizarse para controlar el acceso a recursos web.-->
    <!--/server-status: Recurso que proporciona información sobre el estado del servidor web.-->
    <!--/.ssh: Directorio que contiene claves SSH, que pueden utilizarse para acceder a sistemas remotos.-->
    <!--/.history: Archivo que registra los comandos ejecutados en un shell.-->
    <!--/wallet.dat: Archivo que contiene información sobre una billetera de criptomonedas.-->
  <rule id="31516" level="15" overwrite="yes">
    <if_sid>31100</if_sid>
    <url>.swp$|.bak$|/.htaccess|/server-status|/.ssh|/.history|/wallet.dat</url>
    <description>Suspicious URL access.</description>
    <mitre>
      <id>T1055</id>
    </mitre>
   <group>pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
   </rule>
<!--///////////////////////////////////regla original en 0270-web-appssec-->
<!--La regla 31530 genera una alerta ante una solicitud POST recibida, ésta regla se activa si esas solicitudes son muchas en un periodo de tiempo muy corto-->
  <rule id="31533" level="15" timeframe="20" frequency="8" overwrite="yes">
    <if_matched_sid>31530</if_matched_sid>
    <same_source_ip />
    <description>High amount of POST requests in a small period of time (likely bot).from ip $(srcip)</description>
   <group>pci_dss_6.5,pci_dss_11.4,gdpr_IV_35.7.d,nist_800_53_SA.11,nist_800_53_SI.4,tsc_CC6.6,tsc_CC7.1,tsc_CC8.1,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
    <mitre>
      <id>T1498</id>
    </mitre>
   </rule>

  
  
</group>
